const sExceptLink="concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']",sExceptLink2="concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']",regExFlow=RegExp("/flows/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvir=RegExp("/environments/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvirD=RegExp("/environments/Default-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExpEnviron=RegExp("@parameters(.*?)\\)","gm"),regExpEnviron2=RegExp("@{parameters(.*?)\\)","gm");function CreateReview(e,n,t,i,r,a,o,s){let l=[],c=[],p=[],u=[],f=[],m=[],g=[],d="unknown",h="none",y="none",v="none",$="none",x="none",b="none";(""==o||void 0==o)&&(o="please input");let E=JSON.parse(e),C=getChildren(E.properties.definition,[],0,"root");E.properties?.displayName!=void 0?(n=E.properties.displayName,t=E.name):void 0!=E.name&&(t=E.name),E.properties?.connectionReferences!=void 0&&Object.keys(E.properties.connectionReferences).forEach(e=>{(value=E.properties.connectionReferences[e])?.connection?.connectionReferenceLogicalName!=null&&g.push({connection:e,referenceName:value.connection.connectionReferenceLogicalName,type:value.api.name})});Object.keys(E.properties.definition.triggers).forEach(e=>{value=E.properties.definition.triggers[e],d=e,value?.inputs?.schema!=null&&(h=JSON.stringify(value.inputs)),value?.inputs?.parameters!=null&&(h=JSON.stringify(value.inputs)),value?.inputs?.parameters!=null&&(y=JSON.stringify(value.inputs.parameters)),value?.recurrance!=null&&(b=value.recurrance),value?.conditions!=null&&value.conditions[0]?.expression!=null&&($=value.conditions[0].expression),value?.inputs?.schema?.properties!=null&&(x=JSON.stringify(value.inputs.schema.properties)),value?.runtimeConfiguration!=null&&(v=JSON.stringify(value.runtimeConfiguration))}),C.forEach((e,n)=>{let t="MISSING";e.metadata?.operationMetadataId!=null&&(t=e.metadata.operationMetadataId);let r="",o="",s="";"OpenApiConnection"==e.type?(r=e.inputs.host.operationId,o=e.inputs.host.connectionName,s=e.inputs.host.apiId):r=e.type;let c="Standard",p=null;if(""!=o){let u=a.find(e=>e.name.includes(o.substring(0,o.length-2).trim()));"shared_sendmail"==o||"shared_teams"==o?c="Standard":void 0!=u?(c=u.properties.tier,p=u.properties.iconUri):c="Premium"}let f="",g="|",d="Non-Exception";"{}"==JSON.stringify(e.runAfter)||void 0==e.runAfter||null==e.runAfter?f=e.parent+":Success":Object.keys(e.runAfter).forEach(n=>{g+=n+"|",f=n+":"+JSON.stringify(e.runAfter[n]).replaceAll(","," | "),JSON.stringify(e.runAfter[n]).includes("Failed")&&(d="Exception")}),"|"==g&&0==e.nestedLevel&&(g="|trigger|"),"|"==g&&0!=e.nestedLevel&&(g="|"+e.parent+"|"),f.length>1&&(f=f.substring(0,f.length-1));let h,y=i.find(n=>n.Name.includes(r+o)||n.Name==e.type);h=null!=y?Number(y.Complexity):1;let v="";e?.inputs?.parameters?.$filter!=null&&(v=e.inputs.parameters.$filter);let $="",x="";e?.inputs?.retryPolicy!=null&&($=e.inputs.retryPolicy.type,x=JSON.stringify(e.inputs.retryPolicy));let b="";e?.runtimeConfiguration?.paginationPolicy!=null&&(b=e.runtimeConfiguration.paginationPolicy.minimumItemCount);let E="";e?.runtimeConfiguration?.secureData!=null&&(E=JSON.stringify(e.runtimeConfiguration.secureData).replace('{"properties":[',"").replace("]}","").replaceAll('"',""));let C="";e?.limit?.timeout!=null&&(C=e.limit.timeout);let N="";e?.description!=null&&(N=e.description);let w=e;w.hasOwnProperty("actions")&&delete w.actions;let I=JSON.stringify(removeCircularReferences(w)).match(regExpEnviron),_=!1;I&&(I=I.filter(e=>"@parameters('$authentication')"!=e)).length>0&&(_=!0),!_&&(I=JSON.stringify(removeCircularReferences(w)).match(regExpEnviron2))&&(I=I.filter(e=>"@{parameters('$authentication')"!=e)).length>0&&(_=!0);let k="";e.parent==f.split(":")[0]&&(k="Internal");let A="";A=void 0==e.inputs?"":e.inputs.hasOwnProperty("parameters")?JSON.stringify(e.inputs.parameters):JSON.stringify(e.inputs),e.hasOwnProperty("foreach")&&(A=JSON.stringify(e.foreach)),e.hasOwnProperty("expression")&&(A=JSON.stringify(e.expression)),l.push({name:e.operationName,step:r,type:e.type,id:t,hashId:t+"###"+(n+1),tier:c,connector:o,imgURL:p,runAfter:f.replace(/[\[\]""]/g,""),exception:d,index:n+1,object:e,complexity:h,detail:A,filter:v,pagination:b,secure:E,retry:$,timeout:C,position:g,positionInfo:k,environmentVariables:JSON.stringify(I),environmentB:_,notes:N,parent:e.parent,apiId:s,branch:e.branch}),m.push({step:r,connector:o,name:e.operationName,id:t,hashId:t+"###"+(n+1),object:JSON.stringify(removeCircularReferences(e)),type:e.type,index:n+1,parent:e.parent})}),l.forEach(e=>{if("|trigger|"==e.position)e.positionIndex="|0",e.positionType="|trigger",e.nested="";else{e.positionIndex="",e.positionType="",e.nested="";l.filter(n=>e.position.includes("|"+n.name+"|")).forEach(n=>{e.positionIndex+="|"+Number(n.index),e.positionType+="|"+n.type;let t=getNesting(e.parent,l)+"";"|0"==t.substring(t.length-2,2)&&(t=t.substring(0,t.length-2)),("0"==t||void 0==t||null==t||"undefined"==t)&&(t=""),e.nested=t})}});let N=l.filter(e=>null!=e.detail&&void 0!=e.detail&&"InitializeVariable"!=e.type);C.filter(e=>"InitializeVariable"==e.type).forEach(e=>{let n="",t=!1,i=!1,a=e.inputs.variables[0],o=N.filter(e=>"string"==typeof e.detail&&e.detail.includes(a.name));r.data.filter(e=>e.Type==a.type).length>0&&(n=r.data.find(e=>e.Type==a.type).Letter),a.name.substring(0,r.char)==n&&(t=!0),""!=a.value&&void 0!=a.value&&null!=a.value?a.name.substring(1,a.name.length-1)===a.name.substring(1,a.name.length-1).toUpperCase()&&(i=!0):i=!0;let s="";s=isObject(a.value)?JSON.stringify(a.value):void 0==a.value?"":a.value+"",void 0==a.value&&(a.value=""),c.push({name:a.name,type:a.type,value:s,used:o.length>0,named:t,local:i})}),getDistinct(l).forEach(e=>{let n=l.find(n=>n.connector==e),t=n.apiId,i=g.find(n=>n.connection==e);i&&(t=i.referenceName),p.push({conName:e,appId:t,opId:n.step,count:l.filter(n=>n.connector==e).length})}),f=l.filter(e=>"OpenApiConnection"==e.type),u=l.filter(e=>"Exception"==e.exception);let w;w=0==c.length||c.every(e=>!0===e.named);let I;I=0==c.length||c.every(e=>!0===e.local);let _;_=0==c.length||c.every(e=>!0===e.used);let k=u.filter(e=>"Exception"==e.name),A=!1,R=!1;return k&&(A=k.length>0&&JSON.stringify(k[0].object).includes("Terminate"),R=k.length>0&&(JSON.stringify(k[0].object).includes("concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']")||JSON.stringify(k[0].object).includes("concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']"))),l.forEach(e=>{delete e.object,delete e.apiId;let n=l.find(n=>n.name==e.parent);null!=n&&"If"!=n.type&&"Switch"!=n.type&&(e.branch="")}),{name:n,id:t,environment:s,owner:o,trigger:d,triggerData:y,triggerParam:h,triggerConfig:v,triggerExpress:$,triggerInputs:x,triggerRecur:b,premium:!l.every(e=>"Standard"===e.tier),connectionRefs:p.length,connectors:f.length,steps:l.length,variables:c.length,complexity:sumObj(l,"complexity"),varNaming:w,varNameConsts:I,varNameUse:_,composes:l.filter(e=>"Compose"==e.type).length,exception:u.length,exceptionHandleScope:u.filter(e=>"Scope"==e.step).length>0,exceptionScope:k.length>0,exceptionTerminate:A,exceptionLink:R,mainScope:l.filter(e=>"Main"==e.name).length>0,variableArray:c,actionArray:l,apiActionArray:f,exceptionArray:u,connectionArray:p,error:"",actionObjectArray:m}}function getNesting(e,n){let t;if("root"!=e){let i=n.find(n=>n.name==e);t=i.index,"root"!=i.parent&&(t+="|"+getNesting(i.parent,n))}return t}function getChildren(e,n,t,i){if(e?.actions!=void 0&&Object.keys(e.actions).forEach(r=>{let a=e.actions[r];a.operationName=r,a.nestedLevel=t,a.parent=i,a.branch="Yes",n.push(a),n=getChildren(a,n,t+1,r)}),e?.else!=void 0&&Object.keys(e.else.actions).forEach(r=>{let a=e.else.actions[r];a.operationName=r,a.nestedLevel=t,a.parent=i,a.branch="No",n.push(a),n=getChildren(a,n,t+1,r)}),e?.cases!=void 0){Object.keys(e.cases).forEach(r=>{Object.keys(e.cases[r].actions).forEach(a=>{let o=e.cases[r].actions[a];o.operationName=a,o.nestedLevel=t,o.parent=i,o.branch=r,n.push(o),n=getChildren(o,n,t+1,a)})});Object.keys(e.default.actions).forEach(r=>{let a=e.default.actions[r];a.operationName=r,a.nestedLevel=t,a.parent=i,a.branch="Default",n.push(a),n=getChildren(a,n,t+1,a)})}return n}function sumObj(e=[],n){return e.reduce((e,t)=>e+t[n],0)}function getParent(e){return e.sort((e,n)=>e.value-n.value)[0]}function getDistinct(e){let n=new Set;for(let t of e)""!=t.connector&&n.add(t.connector);return Array.from(n)}function isObject(e){return e&&"object"==typeof e&&e.constructor===Object}function removeCircularReferences(e,n=new WeakSet){return"object"==typeof e&&null!==e?n.has(e)?"[Circular]":(n.add(e),Array.isArray(e))?e.map(e=>removeCircularReferences(e,n)):Object.fromEntries(Object.entries(e).map(([e,t])=>[e,removeCircularReferences(t,n),])):e}const sanitizedObj=removeCircularReferences(obj);function removeItemById(e,n){return e.filter(e=>e.flow!==n)}function distanceBetween(e,n,t){return Math.abs(e.indexOf(n)-e.indexOf(t))}console.log(JSON.stringify(sanitizedObj));