const sExceptLink="concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']",sExceptLink2="concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']",regExFlow=RegExp("/flows/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvir=RegExp("/environments/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvirD=RegExp("/environments/Default-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExpEnviron=RegExp("@parameters(.*?)\\)","gm"),regExpEnviron2=RegExp("@{parameters(.*?)\\)","gm");function CreateReview(e,t,n,i,r,o,a,s){let l=[],p=[],c=[],u=[],f=[],m=[],g=[],d="unknown",y="none",h="none",v="none",$="none",x="none",b="none";(""==a||void 0==a)&&(a="please input");let E=JSON.parse(e),N=getChildren(E.properties.definition,[],0,"root");if(E.properties?.displayName!=void 0?(t=E.properties.displayName,n=E.name):void 0!=E.name&&(n=E.name),E.properties?.connectionReferences!=void 0){let C=Object.keys(E.properties.connectionReferences);C.forEach(e=>{(value=E.properties.connectionReferences[e])?.connection?.connectionReferenceLogicalName!=null&&g.push({connection:e,referenceName:value.connection.connectionReferenceLogicalName,type:value.api.name})})}let w=Object.keys(E.properties.definition.triggers);w.forEach(e=>{value=E.properties.definition.triggers[e],d=e,value?.inputs?.schema!=null&&(y=JSON.stringify(value.inputs)),value?.inputs?.parameters!=null&&(y=JSON.stringify(value.inputs)),value?.inputs?.parameters!=null&&(h=JSON.stringify(value.inputs.parameters)),value?.recurrance!=null&&(b=value.recurrance),value?.conditions!=null&&value.conditions[0]?.expression!=null&&($=value.conditions[0].expression),value?.inputs?.schema?.properties!=null&&(x=JSON.stringify(value.inputs.schema.properties)),value?.runtimeConfiguration!=null&&(v=JSON.stringify(value.runtimeConfiguration))}),N.forEach((e,t)=>{"Html_to_text_4"==e.operationName&&console.log(e);let n="MISSING";e.metadata?.operationMetadataId!=null&&(n=e.metadata.operationMetadataId);let r="",a="",s="";"OpenApiConnection"==e.type?(r=e.inputs.host.operationId,a=e.inputs.host.connectionName,s=e.inputs.host.apiId):r=e.type;let p="Standard",c=null;if(""!=a){let u=o.find(e=>e.name.includes(a.substring(0,a.length-2).trim()));"shared_sendmail"==a||"shared_teams"==a?p="Standard":void 0!=u?(p=u.properties.tier,c=u.properties.iconUri):p="Premium"}let f="",g="|",d="Non-Exception";if("{}"==JSON.stringify(e.runAfter)||void 0==e.runAfter||null==e.runAfter)f=e.parent+":Succeeded";else{let y=Object.keys(e.runAfter);y.forEach(t=>{g+=t+"|",f=t+":"+JSON.stringify(e.runAfter[t]).replaceAll(","," | "),JSON.stringify(e.runAfter[t]).toUpperCase().includes("FAILED")&&(d="Exception")})}"|"==g&&0==e.nestedLevel&&(g="|trigger|"),"|"==g&&0!=e.nestedLevel&&(g="|"+e.parent+"|"),f.length>1&&(f=f.substring(0,f.length-1));let h,v=i.find(t=>t.Name.includes(r+a)||t.Name==e.type);h=null!=v?Number(v.Complexity):1;let $="";e?.inputs?.parameters?.$filter!=null&&($=e.inputs.parameters.$filter);let x="",b="";e?.inputs?.retryPolicy!=null&&(x=e.inputs.retryPolicy.type,b=JSON.stringify(e.inputs.retryPolicy));let E="";e?.runtimeConfiguration?.paginationPolicy!=null&&(E=e.runtimeConfiguration.paginationPolicy.minimumItemCount);let N="";e?.runtimeConfiguration?.secureData!=null&&(N=JSON.stringify(e.runtimeConfiguration.secureData).replace('{"properties":[',"").replace("]}","").replaceAll('"',""));let C="";e?.limit?.timeout!=null&&(C=e.limit.timeout);let w="";e?.description!=null&&(w=e.description);let I=e;removeNestedActions(I),I.hasOwnProperty("cases")&&delete I.cases;let A=JSON.stringify(removeCircularReferences(I)).match(regExpEnviron),_=!1,k=0;A&&(console.log(JSON.stringify(removeCircularReferences(I))),k=(A=A.filter(e=>"@parameters('$authentication')"!=e)).length,A.length>0&&(_=!0));let j="";e.parent==f.split(":")[0]&&(j="Internal");let O="";O=void 0==e.inputs?"":e.inputs.hasOwnProperty("parameters")?JSON.stringify(e.inputs.parameters):JSON.stringify(e.inputs),e.hasOwnProperty("foreach")&&(O=JSON.stringify(e.foreach)),e.hasOwnProperty("expression")&&(O=JSON.stringify(e.expression)),l.push({name:e.operationName,step:r,type:e.type,id:n,hashId:n+"###"+(t+1),tier:p,connector:a,imgURL:c,runAfter:f.replace(/[\[\]""]/g,""),exception:d,index:t+1,object:e,complexity:h,detail:O,filter:$,pagination:E,secure:N,retry:x,timeout:C,position:g,positionInfo:j,environmentVariables:JSON.stringify(A),environmentB:_,environmentCount:k,notes:w,parent:e.parent,apiId:s,branch:e.branch}),m.push({step:r,connector:a,name:e.operationName,id:n,hashId:n+"###"+(t+1),object:JSON.stringify(removeCircularReferences(e)),type:e.type,index:t+1,parent:e.parent})}),l.forEach(e=>{if("|trigger|"==e.position)e.positionIndex="|0",e.positionType="|trigger",e.nested="";else{e.positionIndex="",e.positionType="",e.nested="";let t=l.filter(t=>e.position.includes("|"+t.name+"|"));t.forEach(t=>{e.positionIndex+="|"+Number(t.index),e.positionType+="|"+t.type;let n=e.parent;"string"!=typeof e.parent&&(console.log(e),n=n.parent);let i=getNesting(n,l)+"";"|0"==i.substring(i.length-2,2)&&(i=i.substring(0,i.length-2)),("0"==i||void 0==i||null==i||"undefined"==i)&&(i=""),e.nested=i})}});let I=l.filter(e=>null!=e.detail&&void 0!=e.detail&&"InitializeVariable"!=e.type),A=N.filter(e=>"InitializeVariable"==e.type);A.forEach(e=>{let t="",n=!1,i=!1,o=e.inputs.variables[0],a=I.filter(e=>"string"==typeof e.detail&&e.detail.includes(o.name));r.data.filter(e=>e.Type==o.type).length>0&&(t=r.data.find(e=>e.Type==o.type).Letter),o.name.substring(0,r.char)==t&&(n=!0),""!=o.value&&void 0!=o.value&&null!=o.value?o.name.substring(1,o.name.length-1)===o.name.substring(1,o.name.length-1).toUpperCase()&&(i=!0):i=!0;let s="";s=isObject(o.value)?JSON.stringify(o.value):void 0==o.value?"":o.value+"",void 0==o.value&&(o.value=""),p.push({name:o.name,type:o.type,value:s,used:a.length>0,named:n,local:i})}),getDistinct(l).forEach(e=>{let t=l.find(t=>t.connector==e),n=t.apiId,i=g.find(t=>t.connection==e);i&&(n=i.referenceName),c.push({conName:e,appId:n,opId:t.step,count:l.filter(t=>t.connector==e).length})}),f=l.filter(e=>"OpenApiConnection"==e.type),u=l.filter(e=>"Exception"==e.exception);let _;_=0==p.length||p.every(e=>!0===e.named);let k;k=0==p.length||p.every(e=>!0===e.local);let j;j=0==p.length||p.every(e=>!0===e.used);let O=u.filter(e=>"Exception"==e.name),R=!1,L=!1;return O&&(R=O.length>0&&JSON.stringify(O[0].object).includes("Terminate"),L=O.length>0&&(JSON.stringify(O[0].object).includes("concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']")||JSON.stringify(O[0].object).includes("concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']"))),l.forEach(e=>{delete e.object,delete e.apiId;let t=l.find(t=>t.name==e.parent);null!=t&&"If"!=t.type&&"Switch"!=t.type&&(e.branch="")}),{name:t,id:n,environment:s,owner:a,trigger:d,triggerData:h,triggerParam:y,triggerConfig:v,triggerExpress:$,triggerInputs:x,triggerRecur:b,premium:!l.every(e=>"Standard"===e.tier),connectionRefs:c.length,connectors:f.length,steps:l.length,variables:p.length,complexity:sumObj(l,"complexity"),varNaming:_,varNameConsts:k,varNameUse:j,composes:l.filter(e=>"Compose"==e.type).length,exception:u.length,exceptionHandleScope:u.filter(e=>"Scope"==e.step).length>0,exceptionScope:O.length>0,exceptionTerminate:R,exceptionLink:L,mainScope:l.filter(e=>"Main"==e.name).length>0,variableArray:p,actionArray:l,apiActionArray:f,exceptionArray:u,connectionArray:c,error:"",actionObjectArray:m}}function getNesting(e,t){let n;if("root"!=e){let i=t.find(t=>t.name==e);n=i.index,"root"!=i.parent&&(n+="|"+getNesting(i.parent,t))}return n}function getChildren(e,t,n,i){if("object"==typeof i&&(i=i.operationName),e?.actions!=void 0){let r=Object.keys(e.actions);r.forEach(r=>{let o=e.actions[r];o.operationName=r,o.nestedLevel=n,o.parent=i,o.branch="Yes",t.push(o),t=getChildren(o,t,n+1,r)})}if(e?.else!=void 0){let o=Object.keys(e.else.actions);o.forEach(r=>{let o=e.else.actions[r];o.operationName=r,o.nestedLevel=n,o.parent=i,o.branch="No",t.push(o),t=getChildren(o,t,n+1,r)})}if(e?.cases!=void 0){let a=Object.keys(e.cases);a.forEach(r=>{let o=e.cases[r],a=Object.keys(o.actions);a.forEach(o=>{let a=e.cases[r].actions[o];a.operationName=o,a.nestedLevel=n,a.parent=i,a.branch=r,t.push(a),t=getChildren(a,t,n+1,o)})});let s=Object.keys(e.default.actions);s.forEach(r=>{let o=e.default.actions[r];o.operationName=r,o.nestedLevel=n,o.parent=i,o.branch="Default",t.push(o),t=getChildren(o,t,n+1,o)})}return t}function sumObj(e=[],t){let n=0;return e.reduce((e,n)=>e+n[t],0)}function getParent(e){return e.sort((e,t)=>e.value-t.value)[0]}function getDistinct(e){let t=new Set;for(let n of e)""!=n.connector&&t.add(n.connector);return Array.from(t)}function isObject(e){return e&&"object"==typeof e&&e.constructor===Object}function removeCircularReferences(e,t=new WeakSet){return"object"==typeof e&&null!==e?t.has(e)?"[Circular]":(t.add(e),Array.isArray(e))?e.map(e=>removeCircularReferences(e,t)):Object.fromEntries(Object.entries(e).map(([e,n])=>[e,removeCircularReferences(n,t),])):e}function removeItemById(e,t){return e.filter(e=>e.flow!==t)}function distanceBetween(e,t,n){return Math.abs(e.indexOf(t)-e.indexOf(n))}function removeNestedActions(e){if(e&&"object"==typeof e)for(let t in e.hasOwnProperty("actions")&&delete e.actions,e)e.hasOwnProperty(t)&&"object"==typeof e[t]&&removeNestedActions(e[t])}