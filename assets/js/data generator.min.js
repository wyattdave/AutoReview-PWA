const sExceptLink="concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']",sExceptLink2="concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']",regExFlow=new RegExp("/flows/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvir=new RegExp("/environments/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvirD=new RegExp("/environments/Default-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExpEnviron=new RegExp("@parameters(.*?)\\)","gm"),regExpEnviron2=new RegExp("@{parameters(.*?)\\)","gm");function CreateReview(e,t,n,i,r,a,o,l){let s=[],p=[],u=[],c=[],f=[],g=[],m="unknown",d="none",h="none",y="none",v="none",N="none",x="none";""!=o&&null!=o||(o="please input");const O=JSON.parse(e),b=Object.keys(O.properties.definition.triggers),E=getChildren(O.properties.definition,new Array,0,"root");null!=O.properties?.displayName?(t=O.properties.displayName,n=O.name):null!=O.name&&(n=O.name),b.forEach((e=>{value=O.properties.definition.triggers[e],m=e,null!=value?.inputs?.schema&&(d=JSON.stringify(value.inputs)),null!=value?.inputs?.parameters&&(d=JSON.stringify(value.inputs)),null!=value?.inputs?.parameters&&(h=JSON.stringify(value.inputs.parameters)),null!=value?.recurrance&&(x=e.recurrance),null!=value?.conditions&&null!=value.conditions[0]?.expression&&(v=value.conditions[0].expression),null!=value?.inputs?.schema?.properties&&(N=JSON.stringify(value.inputs.schema.properties)),null!=value?.runtimeConfiguration&&(y=JSON.stringify(value.runtimeConfiguration))})),E.forEach(((e,t)=>{let n="MISSING";null!=e.metadata?.operationMetadataId&&(n=e.metadata.operationMetadataId);let r="",o="",l="";"OpenApiConnection"==e.type?(r=e.inputs.host.operationId,o=e.inputs.host.connectionName,l=e.inputs.host.apiId):r=e.type;let p="Standard",u=null;if(""!=o){let e=a.find((e=>e.name.includes(o.substring(0,o.length-2).trim())));"shared_sendmail"==o||"shared_teams"==o?p="Standard":null!=e?(p=e.properties.tier,u=e.properties.iconUri):p="Premium"}let c,f="",m="|",d="Non-Exception";if("{}"==JSON.stringify(e.runAfter)||null==e.runAfter||null==e.runAfter)f=e.parent+":Success";else{Object.keys(e.runAfter).forEach((t=>{m+=t+"|",f=t+":"+JSON.stringify(e.runAfter[t]).replaceAll(","," | "),JSON.stringify(e.runAfter[t]).includes("Failed")&&(d="Exception")}))}"|"==m&&0==e.nestedLevel&&(m="|trigger|"),"|"==m&&0!=e.nestedLevel&&(m="|"+e.parent+"|"),f.length>1&&(f=f.substring(0,f.length-1));let h=i.find((t=>t.Name.includes(r+o)||t.Name==e.type));c=null!=h?Number(h.Complexity):1;let y="";null!=e?.inputs?.parameters?.$filter&&(y=e.inputs.parameters.$filter);let v="",N="";null!=e?.inputs?.retryPolicy&&(v=e.inputs.retryPolicy.type,N=JSON.stringify(e.inputs.retryPolicy));let x="";null!=e?.runtimeConfiguration?.paginationPolicy&&(x=e.runtimeConfiguration.paginationPolicy.minimumItemCount);let O="";null!=e?.runtimeConfiguration?.secureData&&(O=JSON.stringify(e.runtimeConfiguration.secureData));let b="";null!=e?.limit?.timeout&&(b=e.limit.timeout);let E="";null!=e?.description&&(E=e.description);let S=e;S.hasOwnProperty("actions")&&delete S.actions;let w=JSON.stringify(S).match(regExpEnviron),I=!1;w&&(w=w.filter((e=>"@parameters('$authentication')"!=e)),w.length>0&&(I=!0)),I||(w=JSON.stringify(S).match(regExpEnviron2),w&&(w=w.filter((e=>"@{parameters('$authentication')"!=e)),w.length>0&&(I=!0)));let J="";e.parent==f.split(":")[0]&&(J="Internal");let C="";C=null==e.inputs?"":e.inputs.hasOwnProperty("parameters")?JSON.stringify(e.inputs.parameters):JSON.stringify(e.inputs),e.hasOwnProperty("foreach")&&(C=JSON.stringify(e.foreach)),e.hasOwnProperty("expression")&&(C=JSON.stringify(e.expression)),s.push({name:e.operationName,step:r,type:e.type,id:n,hashId:n+"###"+(t+1),tier:p,connector:o,imgURL:u,runAfter:f.replace(/[\[\]""]/g,""),exception:d,index:t+1,object:e,complexity:c,detail:C,filter:y,pagination:x,secure:O,retry:v,timeout:b,position:m,positionInfo:J,environmentVariables:JSON.stringify(w),environmentB:I,notes:E,parent:e.parent,apiId:l,branch:e.branch}),g.push({step:r,connector:o,name:e.operationName,id:n,hashId:n+"###"+(t+1),object:JSON.stringify(e),type:e.type,index:t+1,parent:e.parent})})),s.forEach((e=>{if("|trigger|"==e.position)e.positionIndex="|0",e.positionType="|trigger",e.nested="";else{e.positionIndex="",e.positionType="",e.nested="";s.filter((t=>e.position.includes("|"+t.name+"|"))).forEach((t=>{e.positionIndex+="|"+Number(t.index),e.positionType+="|"+t.type;let n=getNesting(e.parent,s)+"";"|0"==n.substring(n.length-2,2)&&(n=n.substring(0,n.length-2)),"0"!=n&&null!=n&&null!=n&&"undefined"!=n||(n=""),e.nested=n}))}}));const S=s.filter((e=>null!=e.detail&&null!=e.detail&&"InitializeVariable"!=e.type));let w,I,J;E.filter((e=>"InitializeVariable"==e.type)).forEach((e=>{let t="",n=!1,i=!1;const a=e.inputs.variables[0],o=S.filter((e=>"string"==typeof e.detail&&e.detail.includes(a.name)));r.data.filter((e=>e.Type==a.type)).length>0&&(t=r.data.find((e=>e.Type==a.type)).Letter),a.name.substring(0,r.char)==t&&(n=!0),""!=a.value&&null!=a.value&&null!=a.value?a.name.substring(1,a.name.length-1)===a.name.substring(1,a.name.length-1).toUpperCase()&&(i=!0):i=!0;let l="";l=isObject(a.value)?JSON.stringify(a.value):null==a.value?"":a.value+"",null==a.value&&(a.value=""),p.push({name:a.name,type:a.type,value:l,used:o.length>0,named:n,local:i})})),getDistinct(s).forEach((e=>{const t=s.find((t=>t.connector==e));u.push({conName:e,appId:t.apiId,opId:t.step,count:s.filter((t=>t.connector==e)).length})})),f=s.filter((e=>"OpenApiConnection"==e.type)),c=s.filter((e=>"Exception"==e.exception)),w=0==p.length||p.every((e=>!0===e.named)),I=0==p.length||p.every((e=>!0===e.local)),J=0==p.length||p.every((e=>!0===e.used));let C=c.filter((e=>"Exception"==e.name)),j=!1,A=!1;return C&&(j=C.length>0&&JSON.stringify(C[0].object).includes("Terminate"),A=C.length>0&&(JSON.stringify(C[0].object).includes(sExceptLink)||JSON.stringify(C[0].object).includes(sExceptLink2))),s.forEach((e=>{delete e.object,delete e.apiId;let t=s.find((t=>t.name==e.parent));null!=t&&"If"!=t.type&&"Switch"!=t.type&&(e.branch="")})),{name:t,id:n,environment:l,owner:o,trigger:m,triggerData:h,triggerParam:d,triggerConfig:y,triggerExpress:v,triggerInputs:N,triggerRecur:x,premium:!s.every((e=>"Standard"===e.tier)),connectionRefs:u.length,connectors:f.length,steps:s.length,variables:p.length,complexity:sumObj(s,"complexity"),varNaming:w,varNameConsts:I,varNameUse:J,composes:s.filter((e=>"Compose"==e.type)).length,exception:c.length,exceptionHandleScope:c.filter((e=>"Scope"==e.step)).length>0,exceptionScope:C.length>0,exceptionTerminate:j,exceptionLink:A,mainScope:s.filter((e=>"Main"==e.name)).length>0,variableArray:p,actionArray:s,apiActionArray:f,exceptionArray:c,connectionArray:u,error:"",actionObjectArray:g}}function getNesting(e,t){let n;if("root"!=e){let i=t.find((t=>t.name==e));n=i.index,"root"!=i.parent&&(n+="|"+getNesting(i.parent,t))}return n}function getChildren(e,t,n,i){if(null!=e?.actions){Object.keys(e.actions).forEach((r=>{let a=e.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=i,a.branch="Yes",t.push(a),t=getChildren(a,t,n+1,r)}))}if(null!=e?.else){Object.keys(e.else.actions).forEach((r=>{let a=e.else.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=i,a.branch="No",t.push(a),t=getChildren(a,t,n+1,r)}))}if(null!=e?.cases){Object.keys(e.cases).forEach((r=>{let a=e.cases[r];Object.keys(a.actions).forEach((a=>{let o=e.cases[r].actions[a];o.operationName=a,o.nestedLevel=n,o.parent=i,o.branch=r,t.push(o),t=getChildren(o,t,n+1,a)}))}));Object.keys(e.default.actions).forEach((r=>{let a=e.default.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=i,a.branch="Default",t.push(a),t=getChildren(a,t,n+1,a)}))}return t}function sumObj(e=[],t){let n=0;return n=e.reduce(((e,n)=>e+n[t]),0),n}function getParent(e){return e.sort(((e,t)=>e.value-t.value))[0]}function getDistinct(e){const t=new Set;for(const n of e)""!=n.connector&&t.add(n.connector);return Array.from(t)}function isObject(e){return e&&"object"==typeof e&&e.constructor===Object}function removeItemById(e,t){return e.filter((e=>e.flow!==t))}function distanceBetween(e,t,n){return Math.abs(e.indexOf(t)-e.indexOf(n))}