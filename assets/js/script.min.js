let sDefinition="",sDefinitionParsed="",oReport,oLiveReport,sCustomList=null,oHTML,aConnectionTier=aConnectionTierBackup.value,i=0,iDefinitionFind=0,iDefinitionCount=0,oSaved,oSavedDef,oRatings,oNaming,aComplexity,aScoring,oConfigReference,oSolution,aEnvironmentVar=[],sEnvironment="",oDependencies,bUpdate=!1;const iResetStorage=8,regExpFileID=/[A-Z0-9]{8}-([A-Z0-9]{4}-){3}[A-Z0-9]{12}/m,sHtml='<html><head><meta name="color-scheme" content="dark"></head><body>',pLoading=document.getElementById("loading"),spanVersion=document.getElementById("version"),divCSV=document.getElementById("csvDropdown"),divAdmin=document.getElementById("admin"),butReview=document.getElementById("review-button"),butReport=document.getElementById("report-button"),butSolution=document.getElementById("solution-button"),butShortcut=document.getElementById("shortcut-button"),divDivider=document.getElementById("solution-divider"),butData=document.getElementById("data-button"),butDiagram=document.getElementById("diagram-button"),butDefinition=document.getElementById("definition-button"),lSolution=document.getElementById("solution-container"),tSolution=document.getElementById("solution-title"),iLoad=document.getElementById("loadSaved"),divConfig=document.getElementById("admin"),buLiveFlow=document.getElementById("loadLive");function DownloadCSV(e,n){let t=aDownloadConfig.find(n=>n.name==e),o=sessionStorage.getItem(o),l=oReport.name;if(!1==l&&(l="Flow"),t&&null!=o){if("Actions"==e){let r=oReport.actionArray.slice(0);r.forEach(e=>{e.detail=e.detail.replaceAll(",","|"),e.notes=e.notes.replaceAll(",","|"),e.filter=e.filter.replaceAll(",","|"),e.secure=e.secure.replaceAll(",","|"),e.retry=e.retry.replaceAll(",","|"),delete e.environmentVariables,delete e.environmentB,delete e.branch}),exportCSVFile(t.headers,r,l+"-"+t.name)}else if("Variables"==e){let a=oReport.variableArray.slice(0);a.forEach(e=>{e.value=e.value.replaceAll(",","|"),e.value=e.value.substr(0,200)}),exportCSVFile(t.headers,a,l+"-"+t.name)}else"Connections"==e&&exportCSVFile(t.headers,oReport.connectionArray,l+"-"+t.name)}}function OpenReview(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(oReport.actionArray)),sessionStorage.setItem("review",oHTML.review),sessionStorage.setItem("references",oHTML.references),i=sessionStorage.getItem("windowCounter"),window.open("review.html","Review"+new Date().getTime()+i),i++,sessionStorage.setItem("windowCounter",i)}function OpenReport(){SaveData(),sessionStorage.setItem("report",oHTML.report),i=sessionStorage.getItem("windowCounter"),window.open("report.html","Report"+new Date().getTime()+i),i++,sessionStorage.setItem("windowCounter",i)}function OpenDiagram(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(oReport.actionArray)),sessionStorage.setItem("diagram",createDiagram(oReport.actionArray,oReport.name,oReport.trigger,oReport.actionObjectArray)),sessionStorage.setItem("name",oReport.name),sessionStorage.setItem("id",oReport.id);let e={trigger:oReport.trigger,triggerdata:oReport.triggerData,triggerParam:oReport.triggerParam,triggerConfig:oReport.triggerConfig,triggerExpress:oReport.triggerExpress,triggerInputs:oReport.triggerInputs,triggerRecur:oReport.triggerRecur};sessionStorage.setItem("trigger",JSON.stringify(e)),window.open("diagram.html")}function OpenData(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Data"+new Date().getTime()+i).document.write(sHtml+'<p>Schema:<a href="/Configs/AutoReview-Schema.json">https://github.com/davedidisco/Auto-Review-Self-Config/blob/main/AutoReview-Schema.json</a></p><pre>'+JSON.stringify(oReport,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenDefinition(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Definition"+new Date().getTime()+i).document.write(sHtml+'<p>Schema:<a href="https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#">https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#</a></p><pre>'+JSON.stringify(sDefinitionParsed,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenSolution(){SaveData(),i=sessionStorage.getItem("windowCounter"),sessionStorage.setItem("solution",listSolution(oSolution,sSolutionTemplate)),window.open("./solution.html","Solution Contents"+new Date().getTime()+i),i++,sessionStorage.setItem("windowCounter",i)}function OpenShortcut(){alert("ALT+A Open AutoReview Window \nALT+L Load Previous \nALT+R Open Review \nALT+E Open Report \nALT+D Open Diagram \nALT+C Clear Last Saved")}function OpenBug(){window.open(sMailTemplate,"Bug Email")}function loadSavedFlow(){generateReport(oSaved),oReport=oSaved,sDefinitionParsed=oSavedDef,pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oSaved.name,divDivider.style="display: none",lSolution.style="display: none",tSolution.style="display: none",butSolution.style="display: none",butReview.style="width:100%; display:block",butReport.style="width:100%; display:block",butData.style="display:block;",butDiagram.style="display:block;  width:100%;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;",divConfig.style="display:none;"}function csvAction(){DownloadCSV("Actions",oSaved)}function csvVariables(){DownloadCSV("Variables",oSaved)}function csvConnections(){DownloadCSV("Connections",oSaved)}document.getElementById("review-button").addEventListener("click",OpenReview),document.getElementById("report-button").addEventListener("click",OpenReport),document.getElementById("data-button").addEventListener("click",OpenData),document.getElementById("diagram-button").addEventListener("click",OpenDiagram),document.getElementById("definition-button").addEventListener("click",OpenDefinition),document.getElementById("bugEmail").addEventListener("click",OpenBug),document.getElementById("restConfigs").addEventListener("click",ResetConfigs),document.getElementById("actionsCSVdownload").addEventListener("click",csvAction),document.getElementById("variablesCSVdownload").addEventListener("click",csvVariables),document.getElementById("connectionsCSVdownload").addEventListener("click",csvConnections),document.getElementById("loadSaved").addEventListener("click",loadSavedFlow),document.getElementById("compareFlows").addEventListener("click",OpenCompare),butSolution.addEventListener("click",OpenSolution),butShortcut.addEventListener("click",OpenShortcut),loadPlatform(pLoading);const fileInput=document.getElementById("file-input"),encodingInput="utf-8",fileInputButton=document.getElementById("file-input-button"),passwordInput="";let entries,selectedFile;async function selectFile(){try{fileInputButton.disabled=!0,unpackNestedZipFiles(fileInput.files[0])}catch(e){console.log(e)}finally{fileInputButton.disabled=!1,fileInput.value=""}}async function unpackNestedZipFiles(e){try{if(pLoading.style.color="black",pLoading.innerText="Loading...",e.name.endsWith(".zip")||e.name.endsWith(".msapp")){let n=new zip.ZipReader(new zip.BlobReader(e)),t=await n.getEntries(),o=0;if(t&&t.length)for(let l of(lSolution.style="display: none",divDivider.style="display: none",tSolution.style="display: none",butSolution.style.display="none",lSolution.innerHTML="",sCustomList=null,oSolution=null,iDefinitionFind=0,iDefinitionCount=0,t.find(e=>!e.filenameUTF8),t)){let r=await l.getData(new zip.TextWriter);if(l.filename.includes("definition.json")||l.filename.includes("Workflows/")&&!l.filename.includes("apisMap")&&!l.filename.includes("connectionsMap")){if(o++,console.log(l,"flow"),iDefinitionFind==iDefinitionCount){pLoading.innerHTML="Flow Found...Loading...",review(l,"flow",r);let a=document.createElement("li");a.innerHTML=l.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""),a.value=o,lSolution.appendChild(a),a.addEventListener("click",function(){review(l,"flow",r)})}else{tSolution.style="display: block",divDivider.style="display: block",lSolution.style="display: block; height:124px; overflow-y:auto; overflow-x:hidden";let s=document.createElement("li"),d=document.createTextNode(l.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""));s.appendChild(d),s.value=o,lSolution.appendChild(s),s.addEventListener("click",function(){review(l,"flow",r)})}iDefinitionCount++}else l.filename.includes("customizations.xml")?review(l,"customizations",r):l.filename.includes("solution.xml")?review(l,"solution",r):l.filename.includes("environmentvariabledefinition.xml")?review(l,"environmentVar",r):l.filename.includes("complexityConfig.json")?review(l,"complexity",r):l.filename.includes("namingConfig.json")?review(l,"naming",r):l.filename.includes("scoringConfig.json")?review(l,"scoring",r):l.filename.includes("ratingsConfig.json")&&review(l,"ratings",r)}0!=iDefinitionCount||pLoading.innerHTML.includes("Updated")||(pLoading.innerHTML="No Flows Found in Zip"),bUpdate&&UpdateConfigs(),await n.close()}else pLoading.innerHTML="No a Zip file",console.log(e.name)}catch(p){console.log(p.message),pLoading.innerHTML="Unexpected Error: "+p.message}}async function review(e,n,t){try{if("flow"==n){sDefinitionParsed=JSON.parse(t),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butDefinition.style="width:100%; display:block",oReport=null;let o="";if(e.filename.match(regExpFileID)&&(o=e.filename.match(regExpFileID)[0]),oReport=CreateReview(t,"unknown",o,aComplexity,oNaming,aConnectionTier,""),""==oReport.error){if(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oReport.name,"unknown"==oReport.name&&null!=sCustomList){let l;try{l=sCustomList.ImportExportXml.Workflows.Workflow.find(e=>e.WorkflowId.toUpperCase()=="{"+oReport.id+"}"),butSolution.style.display="block"}catch(r){l=sCustomList.ImportExportXml.Workflows.Workflow}null!=l&&void 0!=l&&(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+l.Name,oReport.name=l.Name)}oSavedDef=sDefinitionParsed,oSaved=oReport;let a;""!=pLoading.innerHTML&&null!=pLoading.innerHTML&&(a=pLoading.innerHTML.replace("_img src=_assets_img_old flow grey fill.svg__&nbsp;","").replace('<img src="assets/img/old flow grey fill.svg">',"")),oHTML=generateReport(oReport,sReviewTemplate,sReportTemplate,a),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butData.style="display:block;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;"}else pLoading.innerHTML=oReport.error,spanVersion.style="display:block;",divCSV.style="display:none;"}else if("customizations"==n){butSolution.style.display="block",sCustomList=xmlToJson.parse(t);let s="",d="",p="",c="",g="",m="",u="";s=sCustomList?.ImportExportXml?.connectionreferences?.connectionreference!=void 0?sCustomList.ImportExportXml.connectionreferences.connectionreference:[],d=sCustomList?.ImportExportXml?.Entities?.Entity!=void 0?sCustomList.ImportExportXml.Entities.Entity:[],p=sCustomList?.ImportExportXml?.FieldSecurityProfiles?.FieldSecurityProfile!=void 0?sCustomList.ImportExportXml.FieldSecurityProfile.FieldSecurityProfiles:[],c=sCustomList?.ImportExportXml?.CanvasApps?.CanvasApp!=void 0?sCustomList.ImportExportXml.CanvasApps.CanvasApp:[],g=sCustomList?.ImportExportXml?.CustomControls?.CustomControl!=void 0?sCustomList.ImportExportXml.CustomControls.CustomControl:[],m=sCustomList?.ImportExportXml?.Roles?.Role!=void 0?sCustomList.ImportExportXml.Roles.Role:[],u=sCustomList?.ImportExportXml?.Languages?.Language!=void 0?sCustomList.ImportExportXml.Languages.Language:"",oSolution={Flows:sCustomList.ImportExportXml.Workflows.Workflow,ConnectionRefs:s,Tables:d,SecurityProfile:p,CanvasApps:c,CustomControls:g,Roles:m,LanguageCode:u}}else if("solution"==n)oDependencies=xmlToJson.parse(t);else if("environmentVar"==n)aEnvironmentVar.push(xmlToJson.parse(t));else if("complexity"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let f=JSON.parse(t).aComplexityTemplate;checkArray("Name","Complexity",f)?(console.log("complex"),oConfigReference={...oConfigReference,complexity:JSON.parse(t).sReference},aComplexity=f,pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("naming"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let y=JSON.parse(t).oNamingTemplate;checkArray("Type","Letter",y.data)&&Object.hasOwn(y,"char")?(console.log("naming"),oConfigReference={...oConfigReference,naming:y.sReference},oNaming=y,pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("scoring"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let L=JSON.parse(t).aScoringTemplate;checkArray("Name","Score",L)&&20==L.length?(console.log("scoring"),oConfigReference={...oConfigReference,score:JSON.parse(t).sReference},aScoring=L,pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("ratings"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let v=JSON.parse(t).oRatingsTemplate;checkRatings(v)?(console.log("rating"),oConfigReference={...oConfigReference,ratings:JSON.parse(t).sReference},oRatings=v,pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Failed, please check JSON</p>",pLoading.style.color="red")}}catch(w){console.log(w),pLoading.innerHTML="Unexpected Error: "+w,pLoading.style.color="red"}}function checkArray(e,n,t){let o=0;for(o=0;o<t.length;o++)if(!Object.hasOwn(t[o],e)||!Object.hasOwn(t[o],n))return!1;return!0}async function fetchAPIData(e,n){try{let t=await fetch(e,{headers:{Authorization:n}});if(!t.ok)throw Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(o){console.error("Error fetching API data:",o)}}fileInput.onchange=selectFile,fileInputButton.onclick=()=>fileInput.dispatchEvent(new MouseEvent("click")),"launchQueue"in window&&launchQueue.setConsumer(async e=>{for(let n of e.files)unpackNestedZipFiles(await n.getFile())});