let oReport,oLiveReport,oSaved,oSavedDef,oRatings,oNaming,aComplexity,aScoring,oConfigReference,oSolution,oDependencies,sDefinition="",sDefinitionParsed="",sCustomList=null,aConnectionTier=aConnectionTierBackup.value,i=0,iDefinitionFind=0,iDefinitionCount=0,sSolutionHTML="",bResetStorage=!1,aEnvironmentVar=[],sEnvironment="";const iResetStorage=8,regExpFileID=new RegExp("[A-Z0-9]{8}-([A-Z0-9]{4}-){3}[A-Z0-9]{12}","m"),sHtml='<html><head><meta name="color-scheme" content="dark"></head><body>';let sReview,sReport,iWarning=0;const sPrem='<img src="assets/img/premium-32.png" class="smallIcon" />',sPrev='<img src="assets/img/preview-32.png" class="smallIcon" />',regExpNewLine=new RegExp("(?:\r\n|\n\r|\r|\n|  )","gm"),regExpFormat=new RegExp("(?:{|})","gm");let sortOrder,user="";const pLoading=document.getElementById("loading"),spanVersion=document.getElementById("version"),divCSV=document.getElementById("csvDropdown"),divAdmin=document.getElementById("admin"),butReview=document.getElementById("review-button"),butReport=document.getElementById("report-button"),butSolution=document.getElementById("solution-button"),butShortcut=document.getElementById("shortcut-button"),divDivider=document.getElementById("solution-divider"),butData=document.getElementById("data-button"),butDiagram=document.getElementById("diagram-button"),butDefinition=document.getElementById("definition-button"),lSolution=document.getElementById("solution-container"),tSolution=document.getElementById("solution-title"),iLoad=document.getElementById("loadSaved"),divConfig=document.getElementById("admin"),buLiveFlow=document.getElementById("loadLive");document.getElementById("review-button").addEventListener("click",OpenReview),document.getElementById("report-button").addEventListener("click",OpenReport),document.getElementById("data-button").addEventListener("click",OpenData),document.getElementById("diagram-button").addEventListener("click",OpenDiagram),document.getElementById("definition-button").addEventListener("click",OpenDefinition),document.getElementById("bugEmail").addEventListener("click",OpenBug),document.getElementById("restConfigs").addEventListener("click",ResetConfigs),document.getElementById("actionsCSVdownload").addEventListener("click",csvAction),document.getElementById("variablesCSVdownload").addEventListener("click",csvVariables),document.getElementById("connectionsCSVdownload").addEventListener("click",csvConnections),document.getElementById("loadSaved").addEventListener("click",loadSavedFlow),document.getElementById("compareFlows").addEventListener("click",OpenCompare),butSolution.addEventListener("click",OpenSolution),butShortcut.addEventListener("click",OpenShortcut);let iReset=localStorage.getItem("reset");function SaveData(){localStorage.setItem("saved",JSON.stringify(oReport)),localStorage.setItem("definition",JSON.stringify(sDefinitionParsed));const e={name:oReport.name,id:oReport.id,data:oReport.actionArray};sessionStorage.setItem("diagram",JSON.stringify(e))}function DownloadCSV(e,t){const n=aDownloadConfig.find((t=>t.name==e)),i=sessionStorage.getItem(i);let o=oReport.name;if(0==o&&(o="Flow"),n&&null!=i)if("Actions"==e){let e=oReport.actionArray.slice(0);e.forEach((e=>{e.detail=e.detail.replaceAll(",","|"),e.notes=e.notes.replaceAll(",","|"),e.filter=e.filter.replaceAll(",","|"),e.secure=e.secure.replaceAll(",","|"),e.retry=e.retry.replaceAll(",","|"),delete e.environmentVariables,delete e.environmentB,delete e.branch})),exportCSVFile(n.headers,e,o+"-"+n.name)}else if("Variables"==e){let e=oReport.variableArray.slice(0);e.forEach((e=>{e.value=e.value.replaceAll(",","|"),e.value=e.value.substr(0,200)})),exportCSVFile(n.headers,e,o+"-"+n.name)}else"Connections"==e&&exportCSVFile(n.headers,oReport.connectionArray,o+"-"+n.name)}function OpenReview(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(oReport.actionArray)),i=sessionStorage.getItem("windowCounter");window.open("","Review"+(new Date).getTime()+i).document.write(sReview),i++,sessionStorage.setItem("windowCounter",i)}function OpenDiagram(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(oReport.actionArray)),sessionStorage.setItem("diagram",createDiagram(oReport.actionArray,oReport.name,oReport.trigger,oReport.actionObjectArray)),sessionStorage.setItem("name",oReport.name),sessionStorage.setItem("id",oReport.id);const e={trigger:oReport.trigger,triggerdata:oReport.triggerData,triggerParam:oReport.triggerParam,triggerConfig:oReport.triggerConfig,triggerExpress:oReport.triggerExpress,triggerInputs:oReport.triggerInputs,triggerRecur:oReport.triggerRecur};sessionStorage.setItem("trigger",JSON.stringify(e)),window.open("diagram.html")}function OpenReport(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Report"+(new Date).getTime()+i).document.write(sReport),i++,sessionStorage.setItem("windowCounter",i)}function OpenCompare(){let e,t=[],n=changeTemplate;const o=localStorage.getItem("defintion");if(null!=o){e=JSON.parse(o);let a=DeepDiff(sDefinitionParsed,e);null==a?a="No differences found":t=a,i=sessionStorage.getItem("windowCounter");let r="",l="";const s='<u>Key</u><br> kind - indicates the kind of change; will be one of the following:<br> kN - indicates a newly added property/element<br> kD - indicates a property/element was deleted<br> kE - indicates a property/element was edited<br> kA - indicates a change occurred within an array<br> kpath - the property path (from the left-hand-side root)<br> klhs - the value on the left-hand-side of the comparison (undefined if kind === "N")<br> krhs - the value on the right-hand-side of the comparison (undefined if kind === "D")<br> kindex - when kind === "A", indicates the array index where the change occurred<br> kitem - when kind === "A", contains a nested change record indicating the change that occurred at the array index<br><br>';let c='<table class="mui-table mui-table--bordered" id="changeTable"><thead><tr><th>Type</th><th>Path</th><th>First Flow</th><th>Second Flow</th></tr></thead><tbody>';t.forEach((e=>{r=null!=e.lhs?JSON.stringify(e.lhs)+"</td><td>":"</td><td>",l=null!=e.rhs?JSON.stringify(e.rhs)+"</td>":"<td>",c+="<tr><td style ='width:40px' id='"+e.kind+"-IN'>"+e.kind+"</td><td>"+JSON.stringify(e.path)+"</td><td>"+r+l+"</tr>"})),c+="</tbody></table><br>",n=n.replace("{flowName}",pLoading.innerText),n=n.replace("{date}",getToday()),n=n.replace("{json}",s+JSON.stringify(a,void 0,2));window.open("","Comparison"+(new Date).getTime()+i).document.write(n.replace("{changeTable}",c)),i++,sessionStorage.setItem("windowCounter",i)}}function OpenData(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Data"+(new Date).getTime()+i).document.write(sHtml+'<p>Schema:<a href="/Configs/AutoReview-Schema.json">https://github.com/davedidisco/Auto-Review-Self-Config/blob/main/AutoReview-Schema.json</a></p><pre>'+JSON.stringify(oReport,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenDefinition(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Definition"+(new Date).getTime()+i).document.write(sHtml+'<p>Schema:<a href="https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#">https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#</a></p><pre>'+JSON.stringify(sDefinitionParsed,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenSolution(){SaveData(),i=sessionStorage.getItem("windowCounter"),sSolutionHTML=listSolution(oSolution);window.open("./solution.html","Solution Contents"+(new Date).getTime()+i).document.write(sSolutionHTML),i++,sessionStorage.setItem("windowCounter",i)}function OpenShortcut(){alert("ALT+A Open AutoReview Window \nALT+L Load Previous \nALT+R Open Review \nALT+E Open Report \nALT+D Open Diagram \nALT+C Clear Last Saved")}function OpenBug(){window.open(sMailTemplate,"Bug Email")}function ResetConfigs(){localStorage.setItem("complexity",JSON.stringify(aComplexityTemplate)),localStorage.setItem("ratings",JSON.stringify(oRatingsTemplate)),localStorage.setItem("score",JSON.stringify(aScoringTemplate)),localStorage.setItem("naming",JSON.stringify(oNamingTemplate)),localStorage.setItem("scoring",JSON.stringify(aScoringTemplate)),ocalStorage.setItem("references",JSON.stringify(oConfigReferenceTemplate)),aComplexity=aComplexityTemplate.slice(),oRatings=oRatingsTemplate,aScoring=aScoringTemplate.slice(0),oNaming=oNamingTemplate,oConfigReference=oConfigReferenceTemplate,pLoading.innerHTML="Config Reset to defaults"}function loadSavedFlow(){generateReport(oSaved),oReport=oSaved,sDefinitionParsed=oSavedDef,pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oSaved.name,divDivider.style="display: none",lSolution.style="display: none",tSolution.style="display: none",butSolution.style="display: none",butReview.style="width:100%; display:block",butReport.style="width:100%; display:block",butData.style="display:block;",butDiagram.style="display:block;  width:100%;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;",divConfig.style="display:none;"}function csvAction(){DownloadCSV("Actions",oSaved)}function csvVariables(){DownloadCSV("Variables",oSaved)}function csvConnections(){DownloadCSV("Connections",oSaved)}null==iReset||bResetStorage||iReset<8&&(bResetStorage=!0,chrome.storage.sync.clear(),pLoading.innerHTML="Config Reset to defaults, please re-upload if required",pLoading.style.color="red"),localStorage.setItem("reset",8),null==localStorage.getItem("complexity")||bResetStorage?(localStorage.setItem("complexity",JSON.stringify(aComplexityTemplate)),aComplexity=aComplexityTemplate.slice()):aComplexity=JSON.parse(localStorage.getItem("complexity")),null==localStorage.getItem("ratings")||bResetStorage?(localStorage.setItem("ratings",JSON.stringify(oRatingsTemplate)),oRatings=oRatingsTemplate):oRatings=JSON.parse(localStorage.getItem("ratings")),null==localStorage.getItem("scoring")||bResetStorage?(localStorage.setItem("scoring",JSON.stringify(aScoringTemplate)),aScoring=aScoringTemplate.slice(0)):aScoring=JSON.parse(localStorage.getItem("scoring")),null==localStorage.getItem("naming")||bResetStorage?(localStorage.setItem("naming",JSON.stringify(oNamingTemplate)),oNaming=oNamingTemplate):oNaming=JSON.parse(localStorage.getItem("naming")),null==localStorage.getItem("references")||bResetStorage?(localStorage.setItem("references",JSON.stringify(oConfigReferenceTemplate)),oConfigReference=oConfigReferenceTemplate):oConfigReference=JSON.parse(localStorage.getItem("references")),null==localStorage.getItem("saved")||null==localStorage.getItem("definition")||bResetStorage?(oSaved=null,oSavedDef=null):(oSaved=JSON.parse(localStorage.getItem("saved")),oSavedDef=JSON.parse(localStorage.getItem("definition"))),localStorage.setItem("naming",JSON.stringify(oNamingTemplate)),localStorage.setItem("complexity",JSON.stringify(aComplexityTemplate));const fileInput=document.getElementById("file-input"),encodingInput="utf-8",fileInputButton=document.getElementById("file-input-button"),passwordInput="";let entries,selectedFile,result;async function selectFile(){try{fileInputButton.disabled=!0,unpackNestedZipFiles(fileInput.files[0])}catch(e){}finally{fileInputButton.disabled=!1,fileInput.value=""}}async function unpackNestedZipFiles(e){try{if(pLoading.innerText="Loading...",e.name.endsWith(".zip")||e.name.endsWith(".msapp")){const t=new zip.ZipReader(new zip.BlobReader(e)),n=await t.getEntries();let i=0;if(n&&n.length){lSolution.style="display: none",divDivider.style="display: none",tSolution.style="display: none",butSolution.style.display="none",lSolution.innerHTML="",sCustomList=null,oSolution=null,iDefinitionFind=0,iDefinitionCount=0;Boolean(!n.find((e=>!e.filenameUTF8)));for(const e of n){const t=await e.getData(new zip.TextWriter);if(e.filename.includes("definition.json")||e.filename.includes("Workflows/")&&!e.filename.includes("apisMap")&&!e.filename.includes("connectionsMap")){if(i++,iDefinitionFind==iDefinitionCount){pLoading.innerHTML="Flow Found...Loading...",review(e,"flow",t);let n=document.createElement("li");n.innerHTML=e.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""),n.value=i,lSolution.appendChild(n),n.addEventListener("click",(function(){review(e,"flow",t)}))}else{tSolution.style="display: block",divDivider.style="display: block",lSolution.style="display: block; height:124px; overflow-y:auto; overflow-x:hidden";const n=document.createElement("li"),o=document.createTextNode(e.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""));n.appendChild(o),n.value=i,lSolution.appendChild(n),n.addEventListener("click",(function(){review(e,"flow",t)}))}iDefinitionCount++}else e.filename.includes("customizations.xml")?review(e,"customizations",t):e.filename.includes("solution.xml")?review(e,"solution",t):e.filename.includes("environmentvariabledefinition.xml")?review(e,"environmentVar",t):e.filename.includes("complexityConfig.json")?review(e,"complexity",t):e.filename.includes("namingConfig.json")?review(e,"naming",t):e.filename.includes("scoringConfig.json")?review(e,"scoring",t):e.filename.includes("ratingsConfig.json")&&review(e,"ratings",t)}}0!=iDefinitionCount||pLoading.innerHTML.includes("Updated")||(pLoading.innerHTML="No Flows Found in Zip"),await t.close()}else pLoading.innerHTML="No a Zip file"}catch(e){pLoading.innerHTML="Unexpected Error: "+e.message}}async function review(e,t,n){try{if("flow"==t){sDefinitionParsed=JSON.parse(n),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butDefinition.style="width:100%; display:block",oReport=null;let t="";if(e.filename.match(regExpFileID)&&(t=e.filename.match(regExpFileID)[0]),oReport=CreateReview(n,"unknown",t,aComplexity,oNaming,aConnectionTier,""),""==oReport.error){if(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oReport.name,"unknown"==oReport.name&&null!=sCustomList){let e;try{e=sCustomList.ImportExportXml.Workflows.Workflow.find((e=>e.WorkflowId.toUpperCase()=="{"+oReport.id+"}".toUpperCase())),butSolution.style.display="block"}catch(t){e=sCustomList.ImportExportXml.Workflows.Workflow}null!=e&&null!=e&&(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+e.Name,oReport.name=e.Name)}oSavedDef=sDefinitionParsed,oSaved=oReport,generateReport(oReport),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butData.style="display:block;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;"}else pLoading.innerHTML=oReport.error,spanVersion.style="display:block;",divCSV.style="display:none;"}else if("customizations"==t){butSolution.style.display="block",sCustomList=xmlToJson.parse(n);let e="",t="",i="",o="",a="",r="",l="";e=null!=sCustomList?.ImportExportXml?.connectionreferences?.connectionreference?sCustomList.ImportExportXml.connectionreferences.connectionreference:[],t=null!=sCustomList?.ImportExportXml?.Entities?.Entity?sCustomList.ImportExportXml.Entities.Entity:[],i=null!=sCustomList?.ImportExportXml?.FieldSecurityProfiles?.FieldSecurityProfile?sCustomList.ImportExportXml.FieldSecurityProfile.FieldSecurityProfiles:[],o=null!=sCustomList?.ImportExportXml?.CanvasApps?.CanvasApp?sCustomList.ImportExportXml.CanvasApps.CanvasApp:[],a=null!=sCustomList?.ImportExportXml?.CustomControls?.CustomControl?sCustomList.ImportExportXml.CustomControls.CustomControl:[],r=null!=sCustomList?.ImportExportXml?.Roles?.Role?sCustomList.ImportExportXml.Roles.Role:[],l=null!=sCustomList?.ImportExportXml?.Languages?.Language?sCustomList.ImportExportXml.Languages.Language:"",oSolution={Flows:sCustomList.ImportExportXml.Workflows.Workflow,ConnectionRefs:e,Tables:t,SecurityProfile:i,CanvasApps:o,CustomControls:a,Roles:r,LanguageCode:l}}else if("solution"==t)oDependencies=xmlToJson.parse(n);else if("environmentVar"==t)aEnvironmentVar.push(xmlToJson.parse(n));else if("complexity"==t){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let e=JSON.parse(n).aComplexityTemplate;checkArray("Name","Complexity",e)?(oConfigReference={...oConfigReference,complexity:JSON.parse(n).sReference},aComplexity=e,pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Updated</p>"):(pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("naming"==t){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let e=JSON.parse(n).oNamingTemplate;checkArray("Type","Letter",e.data)&&Object.hasOwn(e,"char")?(oConfigReference={...oConfigReference,naming:e.sReference},oNaming=e,pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Updated</p>"):(pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("scoring"==t){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let e=JSON.parse(n).aScoringTemplate;checkArray("Name","Score",e)&&20==e.length?(oConfigReference={...oConfigReference,score:JSON.parse(n).sReference},aScoring=e,pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Updated</p>"):(pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("ratings"==t){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let e=JSON.parse(n).oRatingsTemplate;checkRatings(e)?(oConfigReference={...oConfigReference,ratings:JSON.parse(n).sReference},oRatings=e,pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Updated</p>"):(pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Failed, please check JSON</p>",pLoading.style.color="red")}}catch(e){pLoading.innerHTML="Unexpected Error: "+e,pLoading.style.color="red"}}function checkArray(e,t,n){let i=0;for(i=0;i<n.length;i++){if(!Object.hasOwn(n[i],e))return!1;if(!Object.hasOwn(n[i],t))return!1}return!0}function checkRatings(e){return!!Object.hasOwn(e,"complexityAm")&&(!!Object.hasOwn(e,"complexityRe")&&(!!Object.hasOwn(e,"actionsAm")&&(!!Object.hasOwn(e,"actionsRe")&&(!!Object.hasOwn(e,"variablesAm")&&(!!Object.hasOwn(e,"variablesRe")&&(!!Object.hasOwn(e,"exceptionsAm")&&!!Object.hasOwn(e,"exceptionsRe")))))))}function generateReport(e){sReview=sReviewTemplate,sReport=sReportTemplate;let t=0;iWarning=0;const n='<span style="color:orange">&#9888;</span>',o='<span style="color:red">&#10006;</span>';let a="",r=e.name;e.exceptionHandleScope||t++,e.exceptionScope||t++,e.mainScope||t++,1==e.composes?iWarning+=e.composes:e.composes>2&&t++;const l="<p>Com:"+oConfigReference.complexity+" | Rat:"+oConfigReference.ratings+" | Nam:"+oConfigReference.naming+" | Sco:"+oConfigReference.score+"</p>";""!=pLoading.innerHTML&&null!=pLoading.innerHTML&&(r=pLoading.innerHTML.replace("_img src=_assets_img_old flow grey fill.svg__&nbsp;","").replace('<img src="assets/img/old flow grey fill.svg">',""));const s=[e.varNameUse,e.varNaming].every((e=>1==e))||0==e.variables;sReview=sReview.replace("{references}",l),sReview=sReview.replace("{flowName}",r),sReview=sReview.replace("{flowId}",e.id),sReview=sReview.replace("{owner}",e.owner),sReview=sReview.replace("{variable}",s),sReview=sReview.replace("{exception}",e.exceptionScope&&e.exceptionTerminate&&e.exceptionLink),sReview=sReview.replace("{main}",e.mainScope),sReview=sReview.replace("{composes}",e.composes),sReview=sReview.replace("{date}",getToday()),sReview=sReview.replace("{complexity}",e.complexity);let c="";e.premium&&(c=sPrem),sReview=sReview.replace("{premium}",c),sReport=sReport.replace("{flowName}",r),sReport=sReport.replace("{flowId}",e.id),sReport=sReport.replace("{owner}",e.owner),sReport=sReport.replace("{date}",getToday()),e.complexity>oRatings.complexityRe?(sReview=sReview.replace('id="complexity" style="text-align: center; background-color:green;','id="complexity" style="text-align: center; background-color:red;'),iWarning++):e.complexity>oRatings.complexityAm&&(sReview=sReview.replace('id="complexity" style="text-align: center; background-color:green;','id="complexity" style="text-align: center; background-color:orange;'),t++),sReview=sReview.replace("{actions}",e.steps),e.steps>oRatings.actionRe?(sReview=sReview.replace('id="actions" style="text-align: center; background-color:green;','id="actions" style="text-align: center; background-color:red;'),iWarning++):e.steps>oRatings.actionsAm&&(sReview=sReview.replace('id="actions" style="text-align: center; background-color:green;','id="actions" style="text-align: center; background-color:orange;'),t++),sReview=sReview.replace("{variables}",e.variables),e.variables>oRatings.variablesRe?(sReview=sReview.replace('id="variables" style="text-align: center; background-color:green;','id="variables" style="text-align: center; background-color:red;'),iWarning++):e.variables>oRatings.variablesAm&&(sReview=sReview.replace('id="variables" style="text-align: center; background-color:green;','id="variables" style="text-align: center; background-color:orange;'),t++),sReview=sReview.replace("{exceptions}",e.exception),e.exception<=oRatings.exceptionsRe?(sReview=sReview.replace('id="exceptions" style="text-align: center; background-color:green;','id="exceptions" style="text-align: center; background-color:red;'),iWarning++):e.exception<oRatings.exceptions&&(sReview=sReview.replace('id="exceptions" style="text-align: center; background-color:green;','id="exceptions" style="text-align: center; background-color:orange;'),t++);let p='<table class="mui-table mui-table--bordered" id="variablesTable" ><thead><tr><th>Name</th><th>Type</th><th>Value</th><th>Used</th><th>Named</th><th>Constant</th></tr></thead><tbody>';e.variableArray.forEach((e=>{a="",e.local||(iWarning++,a=n),e.used||(t++,a=o),e.named||(t++,a=o),p=p+"<tr><td>"+a+" "+e.name+"</td><td>"+e.type+"</td><td><div contentEditable='true' style='overflow-y:auto; resize:both; background-color:white;'><pre>"+inputFormat(e.value)+"</pre></div></td><td>"+e.used+"</td><td>"+e.named+"</td><td>"+e.local+"</td></tr>"})),p+="</tbody></table>",sReview=sReview.replace("{variablesTable}",p),sReport=sReport.replace("{variablesTable}",p);let d='<table class="mui-table mui-table--bordered"><thead><tr><th>Action</th><th>Name</th><th>Runafter</th></tr></thead><tbody>';e.exceptionArray.forEach((e=>{a="",e.runAfter.includes("TimedOut")||(t++,a=o),d=d+"<tr><td>"+a+" "+e.step+"</td><td>"+e.name+"</td><td>"+e.runAfter+"</td></tr>"})),d+="</tbody></table>",sReview=sReview.replace("{exceptionsTable}",d),sReport=sReport.replace("{exceptionsTable}",d);let g='<table class="mui-table mui-table--bordered" id="actionTable"><thead><tr><th style="max-width:24%">Name</th><th style="max-width:24%">Type</th><th style="max-width:24%">Run After</th><th style="max-width:24%">Notes</th><th>Nested</th><th>Id</th></tr></thead><tbody>';for(i=0;i<e.actionArray.length;i++)g=g+"<tr><td id='"+e.actionArray[i].hashId+"'><a href='#"+e.actionArray[i].hashId+"-IN'>"+e.actionArray[i].name+"</a></td><td>"+apiLink(e.actionArray[i].type,e.actionArray[i].step,e.actionArray[i].hashId)+"</td><td>"+e.actionArray[i].runAfter+"</td><td><div contentEditable='true' style='max-height=100px; overflow-y:auto; resize:vertical;'><pre>"+e.actionArray[i].notes.replaceAll("<","-").replaceAll("£$","")+"</pre></div></td><td>"+e.actionArray[i].nested+"</td><td>"+e.actionArray[i].index+"</td></tr>";g+="</tbody></table>",sReview=sReview.replace("{actionsTable}",g),sReport=sReport.replace("{actionsTable}",g);let m='<table class="mui-table mui-table--bordered" id="inputTable"><thead><tr><th style="width:24%">Name</th><th style="width:14%">Type</th><th style="width:6%">Env</th><th>Inputs</th></tr></thead><tbody>';e.actionArray.forEach((e=>m=m+"<tr><td id='"+e.hashId+"-IN'><a href='#"+e.hashId+"'>"+e.name+"</a></td><td>"+e.step+"</td><td>"+e.environmentB+"</td><td><div contentEditable='true' style='max-height=100px; overflow-y:auto; resize:vertical;'><pre>"+inputFormat(e.detail)+"</pre></div></td></tr>")),m+="</tbody></table>",sReview=sReview.replace("{inputTable}",m),sReport=sReport.replace("{inputTable}",m);let u='<table class="mui-table mui-table--bordered"><thead><tr><th>Name</th><th>Id</th><th>Count</th></tr></thead><tbody>';e.connectionArray.forEach((e=>u=u+"<tr><td>"+e.conName+'</td><td style="max-width:200px">'+e.appId+"</td><td>"+e.count+"</td></tr>")),u+="</tbody></table>",sReview=sReview.replace("{connectionsTable}",u),sReport=sReport.replace("{connectionsTable}",u);let f='<table class="mui-table mui-table--bordered" id="apiTable"><thead><tr><th>Name</th><th>Type</th><th>Connector</th><th>Filter</th><th>Pagination</th><th>Retry</th></tr></thead><tbody>';e.apiActionArray.forEach((e=>{a="",""==e.filter&&"GetItems"==e.step&&(iWarning++,a=n),""!=e.pagination||"GetItems"!=e.step&&!e.step.includes("ListMyTasks")||(iWarning++,a=n),""==e.retry&&"PatchItem"==e.step&&(iWarning++,a=n),"Standard"!=e.tier&&(""!=a&&(a+=" "),"Premium"==e.tier&&(a+=sPrem)),f=f+"<tr><td id='"+e.hashId+"-API'><a href='#"+e.hashId+"'>"+a+" "+e.name+"</td><td>"+e.step+'</td><td style="max-width:200px">'+e.connector+'</td><td style="max-width:200px; max-height:100px; overflow-y:auto;">'+e.filter+"</td><td>"+e.pagination+'</td><td style="max-width:200px; max-height:100px; overflow-y:auto;">'+e.retry+"</td></tr>"})),f+="</tbody></table>",sReview=sReview.replace("{apiTable}",f),sReport=sReport.replace("{apiTable}",f);const y=rating(e);let h='<div style="background-color:#EEEEEE"><div style="width:'+y+'%; background-color:{barColour}; color:white; text-align:center">'+y+"</div></div>";h=y<75?h.replace("{barColour}","red"):y<90?h.replace("{barColour}","orange"):h.replace("{barColour}","green"),h=h+'<table class="mui-table mui-table--bordered"><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><h2>Warnings</h2></td><td><h2>'+iWarning+"</h2></td></tr><tr><td><h2>Failures</h2></td><td><h2>"+t+"</h2></td></tr></tbody></table>",sReview=sReview.replace("{ratingBar}",h);let b="<div style='padding-left:10px'<b>Type: "+e.trigger+"</b><br><p><b>Data: </b>"+e.triggerData+"</b><br><p><b>Parameters: </b>"+e.triggerParam.replaceAll("£$","")+"</p><p><b>Configuration:</b> "+e.triggerConfig.replaceAll("£$","")+"</p><b>Inputs:</b> "+e.triggerInputs.replaceAll("£$","")+"</p><p><b>Recurrence: </b>"+e.triggerRecur+"</p><p><b>Expressions:</b> "+e.triggerExpress+"</p></div>";sReview=sReview.replace("{trigger}",b),sReport=sReport.replace("{trigger}",b);document.getElementById("actionNotes");let v="";e.actionArray.filter((e=>""!=e.notes&&null!=e.notes)).forEach((e=>{v=v+e.name+": "+e.notes+"\n"})),sReview=sReview.replace("{connectorsTable}",""),sReport=sReport.replace("{connectorsTable}",""),sReport=sReport.replaceAll(n,""),sReport=sReport.replaceAll(o,"")}function rating(e){let t=0;e.exceptionScope&&e.exceptionTerminate&&e.exceptionLink&&(t+=aScoring.find((e=>"exceptionScope"==e.Name)).Score),e.mainScope&&(t+=aScoring.find((e=>"mainScope"==e.Name)).Score),e.varNaming&&(t+=aScoring.find((e=>"varNaming"==e.Name)).Score),e.varNameUse&&(t+=aScoring.find((e=>"varUsed"==e.Name)).Score),e.varNameConsts&&(t+=aScoring.find((e=>"varConstant"==e.Name)).Score);let n=aScoring.find((e=>"composes"==e.Name)).Score-e.composes*aScoring.find((e=>"composesDeduction"==e.Name)).Score;n<0&&(n=0),t+=n;let i,o=aScoring.find((e=>"variables"==e.Name)).Score-e.variables*aScoring.find((e=>"variablesDeduction"==e.Name)).Score;o<0&&(o=0),t+=o,i=e.connectionRefs>aScoring.find((e=>"connectionsMin"==e.Name)).Score?aScoring.find((e=>"connections"==e.Name)).Score-(e.connectionRefs-aScoring.find((e=>"connectionsMin"==e.Name)).Score)*aScoring.find((e=>"connectionsDeduction"==e.Name)).Score:aScoring.find((e=>"connections"==e.Name)).Score,i<0&&(i=0),t+=i;let a=aScoring.find((e=>"complexityGreen"==e.Name)).Score;e.complexity>oRatings.complexityRe?a=aScoring.find((e=>"complexityRed"==e.Name)).Score:e.complexity>oRatings.complexityAm&&(a=aScoring.find((e=>"complexityAmber"==e.Name)).Score),t+=a;let r=aScoring.find((e=>"actionsGreen"==e.Name)).Score;return(e.steps>oRatings.actionRe||e.steps>oRatings.actionsAm)&&(r=aScoring.find((e=>"actionsAmber"==e.Name)).Score),t+=r,t}function getToday(){let e=new Date;return[e.getFullYear(),e.getMonth()+1,e.getDate()].join("/")}function apiLink(e,t,n){return"OpenApiConnection"==e?"<a href='#"+n+"-API'>"+t+"</a>":t}function inputFormat(e){if(null==e||null==e)return"";let t=e.replaceAll("<","&lt;").replaceAll("£$","");return t=t.replace(/\\n/g,"\n"),t=t.replace(/\\r/g,""),t=t.replace(/\\t/g,""),t.replaceAll("{","{ \n").replaceAll("}","} \n")}function listSolution(e){let t=sSolutionTemplate,n="",i="",o="";if(t=t.replace("{flowName}",oDependencies.ImportExportXml.SolutionManifest.UniqueName),t=t.replace("{flowId}",oDependencies.ImportExportXml.SolutionManifest.Version),t=t.replace("{owner}",oDependencies.ImportExportXml.SolutionManifest.Publisher.UniqueName),t=t.replace("{date}",getToday()),e.ConnectionRefs.length>0&&(o='<table class="mui-table mui-table--bordered"><thead><tr><th>Name</th><th>Type</th><th>id</th><th>Cusomizable</th></tr></thead><tbody>',e.ConnectionRefs.forEach((e=>{let t=1==e.iscustomizable;o=o+"<tr><td>"+e.connectionreferencedisplayname+"</td><td>"+e.connectorid.split("/apis/")[1]+"</td><td>"+e.connectionreferencelogicalname+"</td><td>"+t+"</td></tr>"})),o+="</tbody></table>"),null!=oDependencies?.ImportExportXml?.SolutionManifest?.MissingDependencies?.MissingDependency){let e=oDependencies.ImportExportXml.SolutionManifest.MissingDependencies.MissingDependency;e&&(n='<table class="mui-table mui-table--bordered"><thead><tr><th>Name</th><th>Type</th><th>Dependent</th></tr></thead><tbody>',e.forEach((e=>{n=n+"<tr><td>"+e.Required.displayName+"</td><td>"+e.Required.type+"</td><td>"+e.Dependent.displayName+"</td></tr>"})),n+="</tbody></table>")}return aEnvironmentVar.length>0&&(i='<table class="mui-table mui-table--bordered"><thead><tr><th>Name</th><th>Type</th><th>Cusomizable</th></tr></thead><tbody>',aEnvironmentVar.forEach((e=>{let t=1==e.environmentvariabledefinition.iscustomizable;i=i+"<tr><td>"+e.environmentvariabledefinition.displayname.default+"</td><td>"+e.environmentvariabledefinition.type+"</td><td>"+t+"</td></tr>"})),i+="</tbody></table>"),t=t.replace("{connectionsTable}",o),t=t.replace("{variablesTable}",i),t=t.replace("{dependenciesTable}",n),t=t.replace("{json}",JSON.stringify(e,void 0,2)),t}async function fetchAPIData(e,t){try{const n={headers:{Authorization:t}},i=await fetch(e,n);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return await i.json()}catch(e){}}fileInput.onchange=selectFile,fileInputButton.onclick=()=>fileInput.dispatchEvent(new MouseEvent("click"));let sActiveTab,owner="",aActionReturn=[],sFlowAPI="",sAPIflow="";const regExFlow=new RegExp("/flows/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvir=new RegExp("/environments/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvirD=new RegExp("/environments/Default-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}");function CreateReview(e,t,n,i,o,a,r,l){let s;const c=new RegExp("@parameters(.*?)\\)","gm"),p=new RegExp("@{parameters(.*?)\\)","gm");aActionReturn.length=0;let d=[],g=[],m=[],u=[],f=[],y="unknown",h="none",b="none",v="none",w="none",S="none",R="none";""!=r&&null!=r||(r="please input"),s=JSON.parse(e),null!=s.properties?.displayName?(t=s.properties.displayName,n=s.name):null!=s.name&&(n=s.name);const x=getChildren(s.properties.definition,new Array,0,"root");Object.keys(s.properties.definition.triggers).forEach((e=>{value=s.properties.definition.triggers[e],y=e,null!=value?.inputs?.schema&&(h=JSON.stringify(value.inputs)),null!=value?.inputs?.parameters&&(h=JSON.stringify(value.inputs)),null!=value?.inputs?.parameters&&(b=JSON.stringify(value.inputs.parameters)),null!=value?.recurrance&&(R=e.recurrance),null!=value?.conditions&&null!=value.conditions[0]?.expression&&(w=value.conditions[0].expression),null!=value?.inputs?.schema?.properties&&(S=JSON.stringify(value.inputs.schema.properties)),null!=value?.runtimeConfiguration&&(v=JSON.stringify(value.runtimeConfiguration))})),x.forEach(((e,t)=>{let n="MISSING";null!=e.metadata?.operationMetadataId&&(n=e.metadata.operationMetadataId);let o="",r="",l="";"OpenApiConnection"==e.type?(o=e.inputs.host.operationId,r=e.inputs.host.connectionName,l=e.inputs.host.apiId):(OpenApiConnection=e.type,o=e.type);let s="Standard",d=null;if(""!=r){let e=a.find((e=>e.name.includes(r.substring(0,r.length-2).trim())));"shared_sendmail"==r||"shared_teams"==r?s="Standard":null!=e?(s=e.properties.tier,d=e.properties.iconUri):s="Premium"}let g,m="",u="|",y="Non-Exception";if("{}"==JSON.stringify(e.runAfter))m=e.parent+":Success";else{Object.keys(e.runAfter).forEach((t=>{u+=t+"|",m=t+":"+JSON.stringify(e.runAfter[t]).replaceAll(","," | "),JSON.stringify(e.runAfter[t]).includes("Failed")&&(y="Exception")}))}"|"==u&&0==e.nestedLevel&&(u="|trigger|"),"|"==u&&0!=e.nestedLevel&&(u="|"+e.parent+"|"),m.length>1&&(m=m.substring(0,m.length-1));let h=i.find((t=>t.Name.includes(o+r)||t.Name==e.type));g=null!=h?Number(h.Complexity):1;let b="";null!=e?.inputs?.parameters?.$filter&&(b=e.inputs.parameters.$filter);let v="",w="";null!=e?.inputs?.retryPolicy&&(v=e.inputs.retryPolicy.type,w=JSON.stringify(e.inputs.retryPolicy));let S="";null!=e?.runtimeConfiguration?.paginationPolicy&&(S=e.runtimeConfiguration.paginationPolicy.minimumItemCount);let R="";null!=e?.runtimeConfiguration?.secureData&&(R=JSON.stringify(e.runtimeConfiguration.secureData));let x="";null!=e?.limit?.timeout&&(x=e.limit.timeout);let C="";null!=e?.description&&(C=e.description);let I=e;I.hasOwnProperty("actions")&&delete I.actions;let N=JSON.stringify(I).match(c),L=!1;N&&(N=N.filter((e=>"@parameters('$authentication')"!=e)),N.length>0&&(L=!0)),L||(N=JSON.stringify(I).match(p),N&&(N=N.filter((e=>"@{parameters('$authentication')"!=e)),N.length>0&&(L=!0)));let E="";e.parent==m.split(":")[0]&&(E="Internal");let T="";T=null==e.inputs?"":e.inputs.hasOwnProperty("parameters")?JSON.stringify(e.inputs.parameters):JSON.stringify(e.inputs),e.hasOwnProperty("foreach")&&(T=JSON.stringify(e.foreach)),e.hasOwnProperty("expression")&&(T=JSON.stringify(e.expression));let O={name:e.operationName,step:o,type:e.type,id:n,hashId:n+"###"+(t+1),tier:s,connector:r,imgURL:d,runAfter:m.replace(/[\[\]""]/g,""),exception:y,index:t+1,object:e,complexity:g,detail:T,filter:b,pagination:S,secure:R,retry:v,timeout:x,position:u,positionInfo:E,environmentVariables:JSON.stringify(N),environmentB:L,notes:C,parent:e.parent,apiId:l,branch:e.branch};aActionReturn.push(O),O={step:o,connector:r,name:e.operationName,id:n,hashId:n+"###"+(t+1),object:JSON.stringify(e),type:e.type,index:t+1,parent:e.parent},f.push(O)})),aActionReturn.forEach((e=>{if("|trigger|"==e.position)e.positionIndex="|0",e.positionType="|trigger",e.nested="";else{e.positionIndex="",e.positionType="",e.nested="";aActionReturn.filter((t=>e.position.includes("|"+t.name+"|"))).forEach((t=>{e.positionIndex+="|"+Number(t.index),e.positionType+="|"+t.type;let n=getNesting(e.parent)+"";"|0"==n.substring(n.length-2,2)&&(n=n.substring(0,n.length-2)),"0"!=n&&null!=n&&null!=n&&"undefined"!=n||(n=""),e.nested=n}))}}));const C=aActionReturn.filter((e=>null!=e.detail&&null!=e.detail&&"InitializeVariable"!=e.type));let I,N,L;x.filter((e=>"InitializeVariable"==e.type)).forEach((e=>{let t="",n=!1,i=!1;const a=e.inputs.variables[0],r=C.filter((e=>"string"==typeof e.detail&&e.detail.includes(a.name)));o.data.filter((e=>e.Type==a.type)).length>0&&(t=o.data.find((e=>e.Type==a.type)).Letter),a.name.substring(0,o.char)==t&&(n=!0),""!=a.value&&null!=a.value&&null!=a.value?a.name.substring(1,a.name.length-1)===a.name.substring(1,a.name.length-1).toUpperCase()&&(i=!0):i=!0;let l="";l=isObject(a.value)?JSON.stringify(a.value):null==a.value?"":a.value+"",null==a.value&&(a.value=""),d.push({name:a.name,type:a.type,value:l,used:r.length>0,named:n,local:i})})),getDistinct(aActionReturn).forEach((e=>{const t=aActionReturn.find((t=>t.connector==e));g.push({conName:e,appId:t.apiId,opId:t.step,count:aActionReturn.filter((t=>t.connector==e)).length})})),u=aActionReturn.filter((e=>"OpenApiConnection"==e.type)),m=aActionReturn.filter((e=>"Exception"==e.exception)),I=0==d.length||d.every((e=>!0===e.named)),N=0==d.length||d.every((e=>!0===e.local)),L=0==d.length||d.every((e=>!0===e.used));let E=m.filter((e=>"Exception"==e.name)),T=!1,O=!1;return E&&(T=E.length>0&&JSON.stringify(E[0].object).includes("Terminate"),O=E.length>0&&(JSON.stringify(E[0].object).includes("concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']")||JSON.stringify(E[0].object).includes("concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']"))),aActionReturn.forEach((e=>{delete e.object,delete e.apiId;let t=aActionReturn.find((t=>t.name==e.parent));null!=t&&"If"!=t.type&&"Switch"!=t.type&&(e.branch="")})),{name:t,id:n,environment:l,owner:r,trigger:y,triggerData:b,triggerParam:h,triggerConfig:v,triggerExpress:w,triggerInputs:S,triggerRecur:R,premium:!aActionReturn.every((e=>"Standard"===e.tier)),connectionRefs:g.length,connectors:u.length,steps:aActionReturn.length,variables:d.length,complexity:sumObj(aActionReturn,"complexity"),varNaming:I,varNameConsts:N,varNameUse:L,composes:aActionReturn.filter((e=>"Compose"==e.type)).length,exception:m.length,exceptionHandleScope:m.filter((e=>"Scope"==e.step)).length>0,exceptionScope:E.length>0,exceptionTerminate:T,exceptionLink:O,mainScope:aActionReturn.filter((e=>"Main"==e.name)).length>0,variableArray:d,actionArray:aActionReturn,apiActionArray:u,exceptionArray:m,connectionArray:g,error:"",actionObjectArray:f}}function getNesting(e){let t;if("root"!=e){let n=aActionReturn.find((t=>t.name==e));t=n.index,"root"!=n.parent&&(t+="|"+getNesting(n.parent))}return t}function getChildren(e,t,n,i){if(null!=e?.actions){Object.keys(e.actions).forEach((o=>{let a=e.actions[o];a.operationName=o,a.nestedLevel=n,a.parent=i,a.branch="Yes",t.push(a),t=getChildren(a,t,n+1,o)}))}if(null!=e?.else){Object.keys(e.else.actions).forEach((o=>{let a=e.else.actions[o];a.operationName=o,a.nestedLevel=n,a.parent=i,a.branch="No",t.push(a),t=getChildren(a,t,n+1,o)}))}if(null!=e?.cases){Object.keys(e.cases).forEach((o=>{let a=e.cases[o];Object.keys(a.actions).forEach((a=>{let r=e.cases[o].actions[a];r.operationName=a,r.nestedLevel=n,r.parent=i,r.branch=o,t.push(r),t=getChildren(r,t,n+1,a)}))}));Object.keys(e.default.actions).forEach((o=>{let a=e.default.actions[o];a.operationName=o,a.nestedLevel=n,a.parent=i,a.branch="Default",t.push(a),t=getChildren(a,t,n+1,a)}))}return t}function sumObj(e=[],t){let n=0;return n=e.reduce(((e,n)=>e+n[t]),0),n}function getParent(e){return e.sort(((e,t)=>e.value-t.value))[0]}function distanceBetween(e,t,n){return Math.abs(e.indexOf(t)-e.indexOf(n))}function getDistinct(e){const t=new Set;for(const n of e)""!=n.connector&&t.add(n.connector);return Array.from(t)}function isObject(e){return e&&"object"==typeof e&&e.constructor===Object}function removeItemById(e,t){return e.filter((e=>e.flow!==t))}"launchQueue"in window&&launchQueue.setConsumer((async e=>{for(const t of e.files){unpackNestedZipFiles(await t.getFile())}}));