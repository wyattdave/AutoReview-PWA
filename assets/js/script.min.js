let sDefinition="",sDefinitionParsed="",oReport,oLiveReport,sCustomList=null,oHTML,aConnectionTier=aConnectionTierBackup.value,i=0,iDefinitionFind=0,iDefinitionCount=0,oSaved,oSavedDef,oRatings,oNaming,aComplexity,aScoring,oConfigReference,oSolution,aEnvironmentVar=[],sEnvironment="",oDependencies,bUpdate=!1,aExceptions=[],aConnectors=[],bFirstFlow=!1,sPreviousFlow="";const iResetStorage=8,regExpFileID=/[A-Z0-9]{8}-([A-Z0-9]{4}-){3}[A-Z0-9]{12}/m,sHtml='<html><head><meta name="color-scheme" content="dark"></head><body>',pLoading=document.getElementById("loading"),spanVersion=document.getElementById("version"),divCSV=document.getElementById("csvDropdown"),divAdmin=document.getElementById("admin"),butReview=document.getElementById("review-button"),butReport=document.getElementById("report-button"),butSolution=document.getElementById("solution-button"),butShortcut=document.getElementById("shortcut-button"),divDivider=document.getElementById("solution-divider"),butData=document.getElementById("data-button"),butDiagram=document.getElementById("diagram-button"),butDefinition=document.getElementById("definition-button"),lSolution=document.getElementById("solution-container"),tSolution=document.getElementById("solution-title"),iLoad=document.getElementById("loadSaved"),divConfig=document.getElementById("admin"),buLiveFlow=document.getElementById("loadLive"),butExcept=document.getElementById("exception-button"),divSolutionName=document.getElementById("solution-name"),butSolutionDiagram=document.getElementById("solutionDiagram-button");butSolutionDiagram.addEventListener("click",OpenSolutionDiagram),document.getElementById("review-button").addEventListener("click",OpenReview),document.getElementById("report-button").addEventListener("click",OpenReport),document.getElementById("data-button").addEventListener("click",OpenData),document.getElementById("diagram-button").addEventListener("click",OpenDiagram),document.getElementById("definition-button").addEventListener("click",OpenDefinition),document.getElementById("bugEmail").addEventListener("click",OpenBug),document.getElementById("restConfigs").addEventListener("click",ResetConfigs),document.getElementById("actionsCSVdownload").addEventListener("click",csvAction),document.getElementById("variablesCSVdownload").addEventListener("click",csvVariables),document.getElementById("connectionsCSVdownload").addEventListener("click",csvConnections),document.getElementById("loadSaved").addEventListener("click",loadSavedFlow),document.getElementById("compareFlows").addEventListener("click",OpenCompare),document.getElementById("addCompare-button").addEventListener("click",AddCompare),butExcept.addEventListener("click",OpenException),butSolution.addEventListener("click",OpenSolution),butShortcut.addEventListener("click",OpenShortcut);const urlParams=new URLSearchParams(window.location.search);let sVersion=urlParams.get("version")||"";function DownloadCSV(e,n){let t=aDownloadConfig.find(n=>n.Name==e),o=oReport.name;if(!1==o&&(o="Flow"),t&&null!=n){if("Actions"==e){let l=oReport.actionArray.slice(0);l.forEach(e=>{e.detail=e.detail.replaceAll(",","|"),e.notes=e.notes.replaceAll(",","|"),e.filter=e.filter.replaceAll(",","|"),e.secure=e.secure.replaceAll(",","|"),e.retry=e.retry.replaceAll(",","|"),delete e.environmentVariables,delete e.environmentB,delete e.branch}),exportCSVFile(t.headers,l,o+"-"+t.Name)}else if("Variables"==e){let a=oReport.variableArray.slice(0);a.forEach(e=>{e.value=e.value.replaceAll(",","|"),e.value=e.value.substr(0,200)}),exportCSVFile(t.headers,a,o+"-"+t.Name)}else"Connections"==e&&exportCSVFile(t.headers,oReport.connectionArray,o+"-"+t.Name)}}function OpenSolutionDiagram(){let e="#direction: right\n#fillArrows: true\n#lineWidth: 2\n#fill:#569AE5\n#background: white\n#acyclicer: greedy\n#ranker: tight-tree\n#.data: visual=database fill=#EBDAF9\n#.trigger: visual=roundrect fill=#569AE5\n#.if: visual=rhomb fill=#2596be\n#.switch: visual=ellipse fill=#2596be\n#.scope: visual=frame fill=#808080\n#.foreach: visual=transceiver fill=#00C1A0\n#.until: visual=sender fill=#00C1A0\n#.var: visual=input fill=#9925be\n#.terminate: visual=receiver fill=#cc4747\n#.var: visual=input fill=#EBDAF9\n",n=[],t=[],o=[];aExceptions.forEach(e=>{t.push({id:e.id,name:e.name}),e.actionObjectArray.forEach(t=>{if(t.flowName=e.name,t.flowId=e.id,"Workflow"==t.type){let o=JSON.parse(t.object);t.childflow=o.inputs.host.workflowReferenceName}else t.childflow="";n.push(t)})});let l=n.filter(e=>"Workflow"==e.type),a=prompt("Would you like to filter out any flows containing search string?").toUpperCase();(null==a||""==a)&&(a="!\xa3$%&^*&(()_)(\xac`"),t.forEach(e=>{l.filter(n=>n.childflow.toUpperCase()==e.id).forEach(n=>{let l=t.find(e=>e.id==n.flowId.toUpperCase()),r="";r=void 0!=l?l.name+"\n"+l.id:n.childflow,e.name.toUpperCase().includes(a)||r.toUpperCase().includes(a)||o.push({link:"["+e.name+"\n"+e.id+"]<:-["+r+"]\n"})})});let r=getUniqueValues(o,"link");if(r.length>0){r.forEach(n=>{e+=n}),i=sessionStorage.getItem("windowCounter");window.open("","Solution Diagram"+new Date().getTime()+i).document.write(sHtml+nomnoml.renderSvg(e)),i++,sessionStorage.setItem("windowCounter",i)}else pLoading.innerText="No Child flows found",pLoading.style.color="red"}function OpenException(){SaveData(),sessionStorage.setItem("exception",createException(aExceptions,oNaming.data,sExceptionTemplate,oDependencies)),i=sessionStorage.getItem("windowCounter"),window.open("exception.html","Exceptions"+new Date().getTime()+i),i++,sessionStorage.setItem("windowCounter",i)}function OpenReview(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(removeCircularReferences(oReport.actionArray))),sessionStorage.setItem("review",oHTML.review),sessionStorage.setItem("references",oHTML.references),i=sessionStorage.getItem("windowCounter"),window.open("review.html","Review"+new Date().getTime()+i),i++,sessionStorage.setItem("windowCounter",i)}function OpenReport(){SaveData(),sessionStorage.setItem("report",oHTML.report),i=sessionStorage.getItem("windowCounter"),window.open("report.html","Report"+new Date().getTime()+i),i++,sessionStorage.setItem("windowCounter",i)}function OpenDiagram(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(removeCircularReferences(oReport.actionArray))),sessionStorage.setItem("diagram",createDiagram(oReport.actionArray,oReport.name,oReport.trigger,oReport.actionObjectArray)),sessionStorage.setItem("name",oReport.name),sessionStorage.setItem("id",oReport.id);let e={trigger:oReport.trigger,triggerData:oReport.triggerData,triggerParam:oReport.triggerParam,triggerConfig:oReport.triggerConfig,triggerExpress:oReport.triggerExpress,triggerInputs:oReport.triggerInputs,triggerRecur:oReport.triggerRecur};sessionStorage.setItem("trigger",JSON.stringify(e)),window.open("diagram.html")}function OpenData(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Data"+new Date().getTime()+i).document.write(sHtml+'<p>Schema:<a href="/Configs/AutoReview-Schema.json">https://github.com/davedidisco/Auto-Review-Self-Config/blob/main/AutoReview-Schema.json</a></p><pre>'+JSON.stringify(oReport,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenDefinition(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Definition"+new Date().getTime()+i).document.write(sHtml+'<p>Schema:<a href="https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#">https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#</a></p><pre>'+JSON.stringify(sDefinitionParsed,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenSolution(){SaveData(),i=sessionStorage.getItem("windowCounter"),sessionStorage.setItem("solution",listSolution(oSolution,sSolutionTemplate,aExceptions,aConnectors)),window.open("./solution.html","Solution Contents"+new Date().getTime()+i),i++,sessionStorage.setItem("windowCounter",i)}function OpenShortcut(){alert("ALT+A Open AutoReview Window \nALT+L Load Previous \nALT+R Open Review \nALT+E Open Report \nALT+D Open Diagram \nALT+C Clear Last Saved")}function OpenBug(){window.open(sMailTemplate,"Bug Email")}function loadSavedFlow(){generateReport(oSaved),oReport=oSaved,sDefinitionParsed=oSavedDef,pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oSaved.name,divDivider.style="display: none",lSolution.style="display: none",tSolution.style="display: none",butSolution.style="display: none",butReview.style="width:100%; display:block",butReport.style="width:100%; display:block",butExcept.style="width:100%; display:block",butData.style="display:block;",butDiagram.style="display:block;  width:100%;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;",divConfig.style="display:none;"}function csvAction(){DownloadCSV("Actions",oSaved)}function csvVariables(){DownloadCSV("Variables",oSaved)}function csvConnections(){DownloadCSV("Connections",oSaved)}function selectFlow(e){pLoading.style.color="black",""!=sPreviousFlow&&(document.getElementById(sPreviousFlow).style="word-break: break-all;"),sPreviousFlow=e,document.getElementById(e).style="background-color:#569AE5;word-break: break-all;"}"beta"==sVersion?document.getElementById("version").innerText+="-Beta":sVersion=localStorage.getItem("version"),"beta"==sVersion&&(document.getElementById("version").innerText+="-Beta"),loadPlatform(pLoading);const fileInput=document.getElementById("file-input"),encodingInput="utf-8",fileInputButton=document.getElementById("file-input-button"),passwordInput="";let entries,selectedFile;async function selectFile(){try{fileInputButton.disabled=!0,unpackNestedZipFiles(fileInput.files[0])}catch(e){console.log(e)}finally{fileInputButton.disabled=!1,fileInput.value=""}}async function unpackNestedZipFiles(e){"beta"==sVersion?butSolutionDiagram.style.display="block":butSolutionDiagram.style.display="none";try{if(sPreviousFlow="",aExceptions=[],aEnvironmentVar=[],aConnectors=[],(void 0==sessionStorage.getItem("compare")||null==sessionStorage.getItem("compare"))&&(document.getElementById("addCompare-button").style="color: #585858;"),pLoading.style.color="black",pLoading.innerText="Loading...",bFirstFlow=!0,e.name.endsWith(".zip")||e.name.endsWith(".msapp")){let n=new zip.ZipReader(new zip.BlobReader(e)),t=await n.getEntries(),o=0;if(t&&t.length)for(let l of(lSolution.style="display: none",divDivider.style="display: none",tSolution.style="display: none",divSolutionName.innerText=" Solution Contents",butSolution.style.display="none",lSolution.innerHTML="",sCustomList=null,oSolution=null,iDefinitionFind=0,iDefinitionCount=0,t.find(e=>!e.filenameUTF8),t)){let a=await l.getData(new zip.TextWriter);if(l.filename.includes("definition.json")&&!l.filename.includes("Connector/")||l.filename.includes("Workflows/")&&!l.filename.includes("apisMap")&&!l.filename.includes("connectionsMap")){if(o++,iDefinitionFind==iDefinitionCount){pLoading.innerHTML="Flow Found...Loading...",review(l,"flow",a,!0);let r=document.createElement("li");r.innerHTML=l.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""),r.value=o,r.style="word-break: break-all;",r.id=l.filename,lSolution.appendChild(r),r.addEventListener("click",function(){review(l,"flow",a,!1)})}else{tSolution.style="display: block",divDivider.style="display: block",lSolution.style="display: block; height:124px; overflow-y:auto; overflow-x:hidden";let s=document.createElement("li"),d=document.createTextNode(l.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""));s.appendChild(d),s.value=o,s.id=l.filename,lSolution.appendChild(s),s.addEventListener("click",function(){review(l,"flow",a,!1)}),""==sPreviousFlow&&(sPreviousFlow=l.filename),review(l,"flow",a,!0),lSolution.scrollTop=lSolution.scrollHeight,document.getElementById(l.filename).focus()}iDefinitionCount++}else if(l.filename.includes("definition.json")&&l.filename.includes("Connector/")){let p=JSON.parse(a);aConnectors.push({name:p.info.title,description:p.info.description,host:p.host})}else l.filename.includes("customizations.xml")?review(l,"customizations",a):l.filename.includes("solution.xml")?review(l,"solution",a,!1):l.filename.includes("environmentvariabledefinition.xml")?review(l,"environmentVar",a,!1):l.filename.includes("complexityConfig.json")?review(l,"complexity",a,!1):l.filename.includes("namingConfig.json")?review(l,"naming",a,!1):l.filename.includes("scoringConfig.json")?review(l,"scoring",a,!1):l.filename.includes("ratingsConfig.json")&&review(l,"ratings",a,!1)}0!=iDefinitionCount||pLoading.innerHTML.includes("Updated")||(pLoading.innerHTML="No Flows Found in Zip"),bUpdate&&UpdateConfigs(),await n.close()}else pLoading.innerHTML="No a Zip file",console.log(e.name)}catch(c){console.log(c.message),pLoading.innerHTML="Unexpected Error: "+c.message}}async function review(e,n,t,o){try{if("flow"==n){sDefinitionParsed=JSON.parse(t),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butExcept.style="display:block;  width:100%;",butDefinition.style="width:100%; display:block",oReport=null;let l="";if(e.filename.match(regExpFileID)&&(l=e.filename.match(regExpFileID)[0]),""!=sPreviousFlow&&selectFlow(e.filename),oReport=CreateReview(t,"unknown",l,aComplexity,oNaming,aConnectionTier,""),""==oReport.error){if(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oReport.name,"unknown"==oReport.name&&null!=sCustomList){let a;try{a=sCustomList.ImportExportXml.Workflows.Workflow.find(e=>e.WorkflowId.toUpperCase()=="{"+oReport.id+"}"),butSolution.style.display="block"}catch(r){a=sCustomList.ImportExportXml.Workflows.Workflow}null!=a&&void 0!=a&&(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+a.Name,oReport.name=a.Name)}if(o&&aExceptions.push(oReport),!o||bFirstFlow){let s;oSavedDef=sDefinitionParsed,oSaved=oReport,oHTML=generateReport(oReport,sReviewTemplate,sReportTemplate,s),""!=pLoading.innerHTML&&null!=pLoading.innerHTML&&(s=pLoading.innerHTML.replace("_img src=_assets_img_old flow grey fill.svg__&nbsp;","").replace('<img src="assets/img/old flow grey fill.svg">',"")),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butExcept.style="display:block;  width:100%;",butData.style="display:block;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;"}let d;""!=pLoading.innerHTML&&null!=pLoading.innerHTML&&(d=pLoading.innerHTML.replace("_img src=_assets_img_old flow grey fill.svg__&nbsp;","").replace('<img src="assets/img/old flow grey fill.svg">',"")),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butExcept.style="display:block;  width:100%;",butData.style="display:block;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;"}else pLoading.innerHTML=oReport.error,spanVersion.style="display:block;",divCSV.style="display:none;"}else if("customizations"==n){butSolution.style.display="block",sCustomList=xmlToJson.parse(t);let p="",c="",m="",u="",g="",f="",y="";p=sCustomList?.ImportExportXml?.connectionreferences?.connectionreference!=void 0?sCustomList.ImportExportXml.connectionreferences.connectionreference:[],c=sCustomList?.ImportExportXml?.Entities?.Entity!=void 0?sCustomList.ImportExportXml.Entities.Entity:[],m=sCustomList?.ImportExportXml?.FieldSecurityProfiles?.FieldSecurityProfile!=void 0?sCustomList.ImportExportXml.FieldSecurityProfile.FieldSecurityProfiles:[],u=sCustomList?.ImportExportXml?.CanvasApps?.CanvasApp!=void 0?sCustomList.ImportExportXml.CanvasApps.CanvasApp:[],g=sCustomList?.ImportExportXml?.CustomControls?.CustomControl!=void 0?sCustomList.ImportExportXml.CustomControls.CustomControl:[],f=sCustomList?.ImportExportXml?.Roles?.Role!=void 0?sCustomList.ImportExportXml.Roles.Role:[],y=sCustomList?.ImportExportXml?.Languages?.Language!=void 0?sCustomList.ImportExportXml.Languages.Language:"",oSolution={Flows:sCustomList.ImportExportXml.Workflows.Workflow,ConnectionRefs:p,Tables:c,SecurityProfile:m,CanvasApps:u,CustomControls:g,Roles:f,LanguageCode:y}}else if("solution"==n)oDependencies=xmlToJson.parse(t),divSolutionName.innerText=oDependencies.ImportExportXml.SolutionManifest.UniqueName;else if("environmentVar"==n)aEnvironmentVar.push(xmlToJson.parse(t));else if("complexity"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let w=JSON.parse(t).aComplexityTemplate;checkArray("Name","Complexity",w)?(console.log("complex"),oConfigReference={...oConfigReference,complexity:JSON.parse(t).sReference},aComplexity=w,pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("naming"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let v=JSON.parse(t).oNamingTemplate;checkArray("Type","Letter",v.data)&&Object.hasOwn(v,"char")?(console.log("naming"),oConfigReference={...oConfigReference,naming:v.sReference},oNaming=v,pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("scoring"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let L=JSON.parse(t).aScoringTemplate;checkArray("Name","Score",L)&&20==L.length?(console.log("scoring"),oConfigReference={...oConfigReference,score:JSON.parse(t).sReference},aScoring=L,pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("ratings"==n){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let b=JSON.parse(t).oRatingsTemplate;checkRatings(b)?(console.log("rating"),oConfigReference={...oConfigReference,ratings:JSON.parse(t).sReference},oRatings=b,pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Updated</p>",bUpdate=!0):(pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Failed, please check JSON</p>",pLoading.style.color="red")}}catch(C){console.log(C),pLoading.innerHTML="Unexpected Error: "+C,pLoading.style.color="red"}}function checkArray(e,n,t){let o=0;for(o=0;o<t.length;o++)if(!Object.hasOwn(t[o],e)||!Object.hasOwn(t[o],n))return!1;return!0}async function fetchAPIData(e,n){try{let t=await fetch(e,{headers:{Authorization:n}});if(!t.ok)throw Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(o){console.error("Error fetching API data:",o)}}function getUniqueValues(e,n){return[...new Set(e.map(e=>e[n]))]}fileInput.onchange=selectFile,fileInputButton.onclick=()=>fileInput.dispatchEvent(new MouseEvent("click")),"launchQueue"in window&&launchQueue.setConsumer(async e=>{for(let n of e.files)unpackNestedZipFiles(await n.getFile())});