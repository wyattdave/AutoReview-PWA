let sDefinition="",sDefinitionParsed="",oReport,oLiveReport,sCustomList=null,aConnectionTier=aConnectionTierBackup.value,i=0,iDefinitionFind=0,iDefinitionCount=0,oSaved,oSavedDef,oRatings,oNaming,aComplexity,aScoring,oConfigReference,oSolution,sSolutionHTML="",bResetStorage=!1,aEnvironmentVar=[],sEnvironment="",oDependencies;const iResetStorage=8,regExpFileID=/[A-Z0-9]{8}-([A-Z0-9]{4}-){3}[A-Z0-9]{12}/m,sHtml='<html><head><meta name="color-scheme" content="dark"></head><body>';let iWarning=0,sReview,sReport;const sPrem='<img src="assets/img/premium-32.png" class="smallIcon" />',sPrev='<img src="assets/img/preview-32.png" class="smallIcon" />',regExpNewLine=RegExp("(?:\r\n|\n\r|\r|\n|  )","gm"),regExpFormat=RegExp("(?:{|})","gm");let sortOrder,user="";const pLoading=document.getElementById("loading"),spanVersion=document.getElementById("version"),divCSV=document.getElementById("csvDropdown"),divAdmin=document.getElementById("admin"),butReview=document.getElementById("review-button"),butReport=document.getElementById("report-button"),butSolution=document.getElementById("solution-button"),butShortcut=document.getElementById("shortcut-button"),divDivider=document.getElementById("solution-divider"),butData=document.getElementById("data-button"),butDiagram=document.getElementById("diagram-button"),butDefinition=document.getElementById("definition-button"),lSolution=document.getElementById("solution-container"),tSolution=document.getElementById("solution-title"),iLoad=document.getElementById("loadSaved"),divConfig=document.getElementById("admin"),buLiveFlow=document.getElementById("loadLive");document.getElementById("review-button").addEventListener("click",OpenReview),document.getElementById("report-button").addEventListener("click",OpenReport),document.getElementById("data-button").addEventListener("click",OpenData),document.getElementById("diagram-button").addEventListener("click",OpenDiagram),document.getElementById("definition-button").addEventListener("click",OpenDefinition),document.getElementById("bugEmail").addEventListener("click",OpenBug),document.getElementById("restConfigs").addEventListener("click",ResetConfigs),document.getElementById("actionsCSVdownload").addEventListener("click",csvAction),document.getElementById("variablesCSVdownload").addEventListener("click",csvVariables),document.getElementById("connectionsCSVdownload").addEventListener("click",csvConnections),document.getElementById("loadSaved").addEventListener("click",loadSavedFlow),document.getElementById("compareFlows").addEventListener("click",OpenCompare),butSolution.addEventListener("click",OpenSolution),butShortcut.addEventListener("click",OpenShortcut);let iReset=localStorage.getItem("reset");function SaveData(){localStorage.setItem("saved",JSON.stringify(oReport)),localStorage.setItem("definition",JSON.stringify(sDefinitionParsed));let e={name:oReport.name,id:oReport.id,data:oReport.actionArray};sessionStorage.setItem("diagram",JSON.stringify(e))}function DownloadCSV(e,t){let n=aDownloadConfig.find(t=>t.name==e),o=sessionStorage.getItem(o),r=oReport.name;if(!1==r&&(r="Flow"),n&&null!=o){if("Actions"==e){let a=oReport.actionArray.slice(0);a.forEach(e=>{e.detail=e.detail.replaceAll(",","|"),e.notes=e.notes.replaceAll(",","|"),e.filter=e.filter.replaceAll(",","|"),e.secure=e.secure.replaceAll(",","|"),e.retry=e.retry.replaceAll(",","|"),delete e.environmentVariables,delete e.environmentB,delete e.branch}),exportCSVFile(n.headers,a,r+"-"+n.name)}else if("Variables"==e){let l=oReport.variableArray.slice(0);l.forEach(e=>{e.value=e.value.replaceAll(",","|"),e.value=e.value.substr(0,200)}),exportCSVFile(n.headers,l,r+"-"+n.name)}else"Connections"==e&&exportCSVFile(n.headers,oReport.connectionArray,r+"-"+n.name)}}function OpenReview(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(oReport.actionArray)),i=sessionStorage.getItem("windowCounter");window.open("","Review"+new Date().getTime()+i).document.write(sReview),i++,sessionStorage.setItem("windowCounter",i)}function OpenDiagram(){SaveData(),sessionStorage.setItem("actions",JSON.stringify(oReport.actionArray)),sessionStorage.setItem("diagram",createDiagram(oReport.actionArray,oReport.name,oReport.trigger,oReport.actionObjectArray)),sessionStorage.setItem("name",oReport.name),sessionStorage.setItem("id",oReport.id);let e={trigger:oReport.trigger,triggerdata:oReport.triggerData,triggerParam:oReport.triggerParam,triggerConfig:oReport.triggerConfig,triggerExpress:oReport.triggerExpress,triggerInputs:oReport.triggerInputs,triggerRecur:oReport.triggerRecur};sessionStorage.setItem("trigger",JSON.stringify(e)),window.open("diagram.html")}function OpenReport(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Report"+new Date().getTime()+i).document.write(sReport),i++,sessionStorage.setItem("windowCounter",i)}function OpenCompare(){let e,t=[],n=changeTemplate,o=localStorage.getItem("defintion");if(void 0!=o){let r=DeepDiff(sDefinitionParsed,e=JSON.parse(o));void 0==r?r="No differences found":t=r,i=sessionStorage.getItem("windowCounter");let a="",l="",s='<table class="mui-table mui-table--bordered" id="changeTable"><thead><tr><th>Type</th><th>Path</th><th>First Flow</th><th>Second Flow</th></tr></thead><tbody>';t.forEach(e=>{a=void 0!=e.lhs?JSON.stringify(e.lhs)+"</td><td>":"</td><td>",l=void 0!=e.rhs?JSON.stringify(e.rhs)+"</td>":"<td>",s+="<tr><td style ='width:40px' id='"+e.kind+"-IN'>"+e.kind+"</td><td>"+JSON.stringify(e.path)+"</td><td>"+a+l+"</tr>"}),s+="</tbody></table><br>",n=(n=(n=n.replace("{flowName}",pLoading.innerText)).replace("{date}",getToday())).replace("{json}",'<u>Key</u><br> kind - indicates the kind of change; will be one of the following:<br> kN - indicates a newly added property/element<br> kD - indicates a property/element was deleted<br> kE - indicates a property/element was edited<br> kA - indicates a change occurred within an array<br> kpath - the property path (from the left-hand-side root)<br> klhs - the value on the left-hand-side of the comparison (undefined if kind === "N")<br> krhs - the value on the right-hand-side of the comparison (undefined if kind === "D")<br> kindex - when kind === "A", indicates the array index where the change occurred<br> kitem - when kind === "A", contains a nested change record indicating the change that occurred at the array index<br><br>'+JSON.stringify(r,void 0,2));window.open("","Comparison"+new Date().getTime()+i).document.write(n.replace("{changeTable}",s)),i++,sessionStorage.setItem("windowCounter",i)}}function OpenData(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Data"+new Date().getTime()+i).document.write(sHtml+'<p>Schema:<a href="/Configs/AutoReview-Schema.json">https://github.com/davedidisco/Auto-Review-Self-Config/blob/main/AutoReview-Schema.json</a></p><pre>'+JSON.stringify(oReport,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenDefinition(){SaveData(),i=sessionStorage.getItem("windowCounter");window.open("","Definition"+new Date().getTime()+i).document.write(sHtml+'<p>Schema:<a href="https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#">https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#</a></p><pre>'+JSON.stringify(sDefinitionParsed,void 0,2)+"</pre></body></html>"),i++,sessionStorage.setItem("windowCounter",i)}function OpenSolution(){SaveData(),i=sessionStorage.getItem("windowCounter"),sSolutionHTML=listSolution(oSolution);window.open("./solution.html","Solution Contents"+new Date().getTime()+i).document.write(sSolutionHTML),i++,sessionStorage.setItem("windowCounter",i)}function OpenShortcut(){alert("ALT+A Open AutoReview Window \nALT+L Load Previous \nALT+R Open Review \nALT+E Open Report \nALT+D Open Diagram \nALT+C Clear Last Saved")}function OpenBug(){window.open(sMailTemplate,"Bug Email")}function ResetConfigs(){localStorage.setItem("complexity",JSON.stringify(aComplexityTemplate)),localStorage.setItem("ratings",JSON.stringify(oRatingsTemplate)),localStorage.setItem("score",JSON.stringify(aScoringTemplate)),localStorage.setItem("naming",JSON.stringify(oNamingTemplate)),localStorage.setItem("scoring",JSON.stringify(aScoringTemplate)),ocalStorage.setItem("references",JSON.stringify(oConfigReferenceTemplate)),aComplexity=aComplexityTemplate.slice(),oRatings=oRatingsTemplate,aScoring=aScoringTemplate.slice(0),oNaming=oNamingTemplate,oConfigReference=oConfigReferenceTemplate,pLoading.innerHTML="Config Reset to defaults"}function loadSavedFlow(){generateReport(oSaved),oReport=oSaved,sDefinitionParsed=oSavedDef,pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oSaved.name,divDivider.style="display: none",lSolution.style="display: none",tSolution.style="display: none",butSolution.style="display: none",butReview.style="width:100%; display:block",butReport.style="width:100%; display:block",butData.style="display:block;",butDiagram.style="display:block;  width:100%;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;",divConfig.style="display:none;"}function csvAction(){DownloadCSV("Actions",oSaved)}function csvVariables(){DownloadCSV("Variables",oSaved)}function csvConnections(){DownloadCSV("Connections",oSaved)}void 0==iReset||bResetStorage||iReset<8&&(bResetStorage=!0,chrome.storage.sync.clear(),pLoading.innerHTML="Config Reset to defaults, please re-upload if required",pLoading.style.color="red",console.log("Config Reset to defaults, please re-upload if required: version8")),localStorage.setItem("reset",8),void 0==localStorage.getItem("complexity")||bResetStorage?(localStorage.setItem("complexity",JSON.stringify(aComplexityTemplate)),aComplexity=aComplexityTemplate.slice()):aComplexity=JSON.parse(localStorage.getItem("complexity")),void 0==localStorage.getItem("ratings")||bResetStorage?(localStorage.setItem("ratings",JSON.stringify(oRatingsTemplate)),oRatings=oRatingsTemplate):oRatings=JSON.parse(localStorage.getItem("ratings")),void 0==localStorage.getItem("scoring")||bResetStorage?(localStorage.setItem("scoring",JSON.stringify(aScoringTemplate)),aScoring=aScoringTemplate.slice(0)):aScoring=JSON.parse(localStorage.getItem("scoring")),void 0==localStorage.getItem("naming")||bResetStorage?(localStorage.setItem("naming",JSON.stringify(oNamingTemplate)),oNaming=oNamingTemplate):oNaming=JSON.parse(localStorage.getItem("naming")),void 0==localStorage.getItem("references")||bResetStorage?(localStorage.setItem("references",JSON.stringify(oConfigReferenceTemplate)),oConfigReference=oConfigReferenceTemplate):oConfigReference=JSON.parse(localStorage.getItem("references")),void 0==localStorage.getItem("saved")||void 0==localStorage.getItem("definition")||bResetStorage?(oSaved=null,oSavedDef=null):(oSaved=JSON.parse(localStorage.getItem("saved")),oSavedDef=JSON.parse(localStorage.getItem("definition"))),localStorage.setItem("naming",JSON.stringify(oNamingTemplate)),localStorage.setItem("complexity",JSON.stringify(aComplexityTemplate));const fileInput=document.getElementById("file-input"),encodingInput="utf-8",fileInputButton=document.getElementById("file-input-button"),passwordInput="";let entries,selectedFile;async function selectFile(){try{fileInputButton.disabled=!0,unpackNestedZipFiles(fileInput.files[0])}catch(e){console.log(e)}finally{fileInputButton.disabled=!1,fileInput.value=""}}async function unpackNestedZipFiles(e){try{if(pLoading.innerText="Loading...",console.log(e),e.name.endsWith(".zip")||e.name.endsWith(".msapp")){let t=new zip.ZipReader(new zip.BlobReader(e));console.log(t);let n=await t.getEntries();console.log(n);let o=0;if(n&&n.length)for(let r of(lSolution.style="display: none",divDivider.style="display: none",tSolution.style="display: none",butSolution.style.display="none",lSolution.innerHTML="",sCustomList=null,oSolution=null,iDefinitionFind=0,iDefinitionCount=0,n.find(e=>!e.filenameUTF8),n)){let a=await r.getData(new zip.TextWriter);if(r.filename.includes("definition.json")||r.filename.includes("Workflows/")&&!r.filename.includes("apisMap")&&!r.filename.includes("connectionsMap")){if(o++,console.log(r,"flow"),iDefinitionFind==iDefinitionCount){pLoading.innerHTML="Flow Found...Loading...",review(r,"flow",a);let l=document.createElement("li");l.innerHTML=r.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""),l.value=o,lSolution.appendChild(l),l.addEventListener("click",function(){review(r,"flow",a)})}else{tSolution.style="display: block",divDivider.style="display: block",lSolution.style="display: block; height:124px; overflow-y:auto; overflow-x:hidden";let s=document.createElement("li"),c=document.createTextNode(r.filename.replace("Workflows/","").replace(regExpFileID,"").replace("-.json",""));s.appendChild(c),s.value=o,lSolution.appendChild(s),s.addEventListener("click",function(){review(r,"flow",a)})}iDefinitionCount++}else r.filename.includes("customizations.xml")?review(r,"customizations",a):r.filename.includes("solution.xml")?review(r,"solution",a):r.filename.includes("environmentvariabledefinition.xml")?review(r,"environmentVar",a):r.filename.includes("complexityConfig.json")?review(r,"complexity",a):r.filename.includes("namingConfig.json")?review(r,"naming",a):r.filename.includes("scoringConfig.json")?review(r,"scoring",a):r.filename.includes("ratingsConfig.json")&&review(r,"ratings",a)}0!=iDefinitionCount||pLoading.innerHTML.includes("Updated")||(pLoading.innerHTML="No Flows Found in Zip"),await t.close()}else pLoading.innerHTML="No a Zip file",console.log(e.name)}catch(d){console.log(d.message),pLoading.innerHTML="Unexpected Error: "+d.message}}async function review(e,t,n){try{if("flow"==t){sDefinitionParsed=JSON.parse(n),console.log(e,t),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butDefinition.style="width:100%; display:block",oReport=null;let o="";if(e.filename.match(regExpFileID)&&(o=e.filename.match(regExpFileID)[0]),oReport=CreateReview(n,"unknown",o,aComplexity,oNaming,aConnectionTier,""),""==oReport.error){if(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+oReport.name,"unknown"==oReport.name&&null!=sCustomList){let r;try{r=sCustomList.ImportExportXml.Workflows.Workflow.find(e=>e.WorkflowId.toUpperCase()=="{"+oReport.id+"}"),butSolution.style.display="block"}catch(a){r=sCustomList.ImportExportXml.Workflows.Workflow}null!=r&&void 0!=r&&(pLoading.innerHTML='<img src="assets/img/old flow grey fill.svg"/>&nbsp;'+r.Name,oReport.name=r.Name)}oSavedDef=sDefinitionParsed,oSaved=oReport,generateReport(oReport),butReview.style="display:block;  width:100%;",butDiagram.style="display:block;  width:100%;",butReport.style="display:block;  width:100%;",butData.style="display:block;",spanVersion.style="display:none;",divCSV.style="display:block; width:100%;",divAdmin.style="display:none;"}else pLoading.innerHTML=oReport.error,spanVersion.style="display:block;",divCSV.style="display:none;"}else if("customizations"==t){butSolution.style.display="block",sCustomList=xmlToJson.parse(n);let l="",s="",c="",d="",p="",g="",m="";l=sCustomList?.ImportExportXml?.connectionreferences?.connectionreference!=void 0?sCustomList.ImportExportXml.connectionreferences.connectionreference:[],s=sCustomList?.ImportExportXml?.Entities?.Entity!=void 0?sCustomList.ImportExportXml.Entities.Entity:[],c=sCustomList?.ImportExportXml?.FieldSecurityProfiles?.FieldSecurityProfile!=void 0?sCustomList.ImportExportXml.FieldSecurityProfile.FieldSecurityProfiles:[],d=sCustomList?.ImportExportXml?.CanvasApps?.CanvasApp!=void 0?sCustomList.ImportExportXml.CanvasApps.CanvasApp:[],p=sCustomList?.ImportExportXml?.CustomControls?.CustomControl!=void 0?sCustomList.ImportExportXml.CustomControls.CustomControl:[],g=sCustomList?.ImportExportXml?.Roles?.Role!=void 0?sCustomList.ImportExportXml.Roles.Role:[],m=sCustomList?.ImportExportXml?.Languages?.Language!=void 0?sCustomList.ImportExportXml.Languages.Language:"",oSolution={Flows:sCustomList.ImportExportXml.Workflows.Workflow,ConnectionRefs:l,Tables:s,SecurityProfile:c,CanvasApps:d,CustomControls:p,Roles:g,LanguageCode:m}}else if("solution"==t)oDependencies=xmlToJson.parse(n);else if("environmentVar"==t)aEnvironmentVar.push(xmlToJson.parse(n));else if("complexity"==t){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let u=JSON.parse(n).aComplexityTemplate;checkArray("Name","Complexity",u)?(console.log("complex"),oConfigReference={...oConfigReference,complexity:JSON.parse(n).sReference},aComplexity=u,pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Updated</p>"):(pLoading.innerHTML=pLoading.innerHTML+"<p>Complexity Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("naming"==t){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let f=JSON.parse(n).oNamingTemplate;checkArray("Type","Letter",f.data)&&Object.hasOwn(f,"char")?(console.log("naming"),oConfigReference={...oConfigReference,naming:f.sReference},oNaming=f,pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Updated</p>"):(pLoading.innerHTML=pLoading.innerHTML+"<p> Naming Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("scoring"==t){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let y=JSON.parse(n).aScoringTemplate;checkArray("Name","Score",y)&&20==y.length?(console.log("scoring"),oConfigReference={...oConfigReference,score:JSON.parse(n).sReference},aScoring=y,pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Updated</p>"):(pLoading.innerHTML=pLoading.innerHTML+"<p>Scoring Config Failed, please check JSON</p>",pLoading.style.color="red")}else if("ratings"==t){pLoading.innerHTML=pLoading.innerHTML.replace("Loading...","<b>Config Updates:</b>");let h=JSON.parse(n).oRatingsTemplate;checkRatings(h)?(console.log("rating"),oConfigReference={...oConfigReference,ratings:JSON.parse(n).sReference},oRatings=h,pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Updated</p>"):(pLoading.innerHTML=pLoading.innerHTML+"<p>Ratings Config Failed, please check JSON</p>",pLoading.style.color="red")}}catch(v){console.log(v),pLoading.innerHTML="Unexpected Error: "+v,pLoading.style.color="red"}}function checkArray(e,t,n){let o=0;for(o=0;o<n.length;o++)if(!Object.hasOwn(n[o],e)||!Object.hasOwn(n[o],t))return!1;return!0}function checkRatings(e){return!!(Object.hasOwn(e,"complexityAm")&&Object.hasOwn(e,"complexityRe")&&Object.hasOwn(e,"actionsAm")&&Object.hasOwn(e,"actionsRe")&&Object.hasOwn(e,"variablesAm")&&Object.hasOwn(e,"variablesRe")&&Object.hasOwn(e,"exceptionsAm")&&Object.hasOwn(e,"exceptionsRe"))}function generateReport(e){sReview=sReviewTemplate,sReport=sReportTemplate;let t=0;iWarning=0;let n='<span style="color:orange">&#9888;</span>',o='<span style="color:red">&#10006;</span>',r="",a=e.name;!e.exceptionHandleScope&&t++,!e.exceptionScope&&t++,!e.mainScope&&t++,1==e.composes?iWarning+=e.composes:e.composes>2&&t++;let l="<p>Com:"+oConfigReference.complexity+" | Rat:"+oConfigReference.ratings+" | Nam:"+oConfigReference.naming+" | Sco:"+oConfigReference.score+"</p>";""!=pLoading.innerHTML&&null!=pLoading.innerHTML&&(a=pLoading.innerHTML.replace("_img src=_assets_img_old flow grey fill.svg__&nbsp;","").replace('<img src="assets/img/old flow grey fill.svg">',""));let s=[e.varNameUse,e.varNaming].every(e=>!0==e)||0==e.variables;sReview=(sReview=(sReview=(sReview=(sReview=(sReview=(sReview=(sReview=(sReview=(sReview=sReview.replace("{references}",l)).replace("{flowName}",a)).replace("{flowId}",e.id)).replace("{owner}",e.owner)).replace("{variable}",s)).replace("{exception}",e.exceptionScope&&e.exceptionTerminate&&e.exceptionLink)).replace("{main}",e.mainScope)).replace("{composes}",e.composes)).replace("{date}",getToday())).replace("{complexity}",e.complexity);let c="";e.premium&&(c=sPrem),sReview=sReview.replace("{premium}",c),sReport=(sReport=(sReport=(sReport=sReport.replace("{flowName}",a)).replace("{flowId}",e.id)).replace("{owner}",e.owner)).replace("{date}",getToday()),e.complexity>oRatings.complexityRe?(sReview=sReview.replace('id="complexity" style="text-align: center; background-color:green;','id="complexity" style="text-align: center; background-color:red;'),iWarning++):e.complexity>oRatings.complexityAm&&(sReview=sReview.replace('id="complexity" style="text-align: center; background-color:green;','id="complexity" style="text-align: center; background-color:orange;'),t++),sReview=sReview.replace("{actions}",e.steps),e.steps>oRatings.actionRe?(sReview=sReview.replace('id="actions" style="text-align: center; background-color:green;','id="actions" style="text-align: center; background-color:red;'),iWarning++):e.steps>oRatings.actionsAm&&(sReview=sReview.replace('id="actions" style="text-align: center; background-color:green;','id="actions" style="text-align: center; background-color:orange;'),t++),sReview=sReview.replace("{variables}",e.variables),e.variables>oRatings.variablesRe?(sReview=sReview.replace('id="variables" style="text-align: center; background-color:green;','id="variables" style="text-align: center; background-color:red;'),iWarning++):e.variables>oRatings.variablesAm&&(sReview=sReview.replace('id="variables" style="text-align: center; background-color:green;','id="variables" style="text-align: center; background-color:orange;'),t++),sReview=sReview.replace("{exceptions}",e.exception),e.exception<=oRatings.exceptionsRe?(sReview=sReview.replace('id="exceptions" style="text-align: center; background-color:green;','id="exceptions" style="text-align: center; background-color:red;'),iWarning++):e.exception<oRatings.exceptions&&(sReview=sReview.replace('id="exceptions" style="text-align: center; background-color:green;','id="exceptions" style="text-align: center; background-color:orange;'),t++);let d='<table class="mui-table mui-table--bordered" id="variablesTable" ><thead><tr><th>Name</th><th>Type</th><th>Value</th><th>Used</th><th>Named</th><th>Constant</th></tr></thead><tbody>';e.variableArray.forEach(e=>{r="",e.local||(iWarning++,r=n),e.used||(t++,r=o),e.named||(t++,r=o),d=d+"<tr><td>"+r+" "+e.name+"</td><td>"+e.type+"</td><td><div contentEditable='true' style='overflow-y:auto; resize:both; background-color:white;'><pre>"+inputFormat(e.value)+"</pre></div></td><td>"+e.used+"</td><td>"+e.named+"</td><td>"+e.local+"</td></tr>"}),d+="</tbody></table>",sReview=sReview.replace("{variablesTable}",d),sReport=sReport.replace("{variablesTable}",d);let p='<table class="mui-table mui-table--bordered"><thead><tr><th>Action</th><th>Name</th><th>Runafter</th></tr></thead><tbody>';e.exceptionArray.forEach(e=>{r="",e.runAfter.includes("TimedOut")||(t++,r=o),p=p+"<tr><td>"+r+" "+e.step+"</td><td>"+e.name+"</td><td>"+e.runAfter+"</td></tr>"}),p+="</tbody></table>",sReview=sReview.replace("{exceptionsTable}",p),sReport=sReport.replace("{exceptionsTable}",p);let g='<table class="mui-table mui-table--bordered" id="actionTable"><thead><tr><th style="max-width:24%">Name</th><th style="max-width:24%">Type</th><th style="max-width:24%">Run After</th><th style="max-width:24%">Notes</th><th>Nested</th><th>Id</th></tr></thead><tbody>';for(i=0;i<e.actionArray.length;i++)g=g+"<tr><td id='"+e.actionArray[i].hashId+"'><a href='#"+e.actionArray[i].hashId+"-IN'>"+e.actionArray[i].name+"</a></td><td>"+apiLink(e.actionArray[i].type,e.actionArray[i].step,e.actionArray[i].hashId)+"</td><td>"+e.actionArray[i].runAfter+"</td><td><div contentEditable='true' style='max-height=100px; overflow-y:auto; resize:vertical;'><pre>"+e.actionArray[i].notes.replaceAll("<","-").replaceAll("\xa3$","")+"</pre></div></td><td>"+e.actionArray[i].nested+"</td><td>"+e.actionArray[i].index+"</td></tr>";g+="</tbody></table>",sReview=sReview.replace("{actionsTable}",g),sReport=sReport.replace("{actionsTable}",g);let m='<table class="mui-table mui-table--bordered" id="inputTable"><thead><tr><th style="width:24%">Name</th><th style="width:14%">Type</th><th style="width:6%">Env</th><th>Inputs</th></tr></thead><tbody>';e.actionArray.forEach(e=>m=m+"<tr><td id='"+e.hashId+"-IN'><a href='#"+e.hashId+"'>"+e.name+"</a></td><td>"+e.step+"</td><td>"+e.environmentB+"</td><td><div contentEditable='true' style='max-height=100px; overflow-y:auto; resize:vertical;'><pre>"+inputFormat(e.detail)+"</pre></div></td></tr>"),m+="</tbody></table>",sReview=sReview.replace("{inputTable}",m),sReport=sReport.replace("{inputTable}",m);let u='<table class="mui-table mui-table--bordered"><thead><tr><th>Name</th><th>Id</th><th>Count</th></tr></thead><tbody>';e.connectionArray.forEach(e=>u=u+"<tr><td>"+e.conName+'</td><td style="max-width:200px">'+e.appId+"</td><td>"+e.count+"</td></tr>"),u+="</tbody></table>",sReview=sReview.replace("{connectionsTable}",u),sReport=sReport.replace("{connectionsTable}",u);let f='<table class="mui-table mui-table--bordered" id="apiTable"><thead><tr><th>Name</th><th>Type</th><th>Connector</th><th>Filter</th><th>Pagination</th><th>Retry</th></tr></thead><tbody>';e.apiActionArray.forEach(e=>{r="",""==e.filter&&"GetItems"==e.step&&(iWarning++,r=n),""==e.pagination&&("GetItems"==e.step||e.step.includes("ListMyTasks"))&&(iWarning++,r=n),""==e.retry&&"PatchItem"==e.step&&(iWarning++,r=n),"Standard"!=e.tier&&(""!=r&&(r+=" "),"Premium"==e.tier&&(r+=sPrem)),f=f+"<tr><td id='"+e.hashId+"-API'><a href='#"+e.hashId+"'>"+r+" "+e.name+"</td><td>"+e.step+'</td><td style="max-width:200px">'+e.connector+'</td><td style="max-width:200px; max-height:100px; overflow-y:auto;">'+e.filter+"</td><td>"+e.pagination+'</td><td style="max-width:200px; max-height:100px; overflow-y:auto;">'+e.retry+"</td></tr>"}),f+="</tbody></table>",sReview=sReview.replace("{apiTable}",f),sReport=sReport.replace("{apiTable}",f);let y=rating(e),h='<div style="background-color:#EEEEEE"><div style="width:'+y+'%; background-color:{barColour}; color:white; text-align:center">'+y+"</div></div>";h=(h=y<75?h.replace("{barColour}","red"):y<90?h.replace("{barColour}","orange"):h.replace("{barColour}","green"))+'<table class="mui-table mui-table--bordered"><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><h2>Warnings</h2></td><td><h2>'+iWarning+"</h2></td></tr><tr><td><h2>Failures</h2></td><td><h2>"+t+"</h2></td></tr></tbody></table>",sReview=sReview.replace("{ratingBar}",h);let v="<div style='padding-left:10px'<b>Type: "+e.trigger+"</b><br><p><b>Data: </b>"+e.triggerData+"</b><br><p><b>Parameters: </b>"+e.triggerParam.replaceAll("\xa3$","")+"</p><p><b>Configuration:</b> "+e.triggerConfig.replaceAll("\xa3$","")+"</p><b>Inputs:</b> "+e.triggerInputs.replaceAll("\xa3$","")+"</p><p><b>Recurrence: </b>"+e.triggerRecur+"</p><p><b>Expressions:</b> "+e.triggerExpress+"</p></div>";sReview=sReview.replace("{trigger}",v),sReport=sReport.replace("{trigger}",v),document.getElementById("actionNotes");let b="";e.actionArray.filter(e=>""!=e.notes&&null!=e.notes).forEach(e=>{b=b+e.name+": "+e.notes+"\n"}),sReview=sReview.replace("{connectorsTable}",""),sReport=(sReport=(sReport=sReport.replace("{connectorsTable}","")).replaceAll(n,"")).replaceAll(o,"")}function rating(e){let t=0;e.exceptionScope&&e.exceptionTerminate&&e.exceptionLink&&(t+=aScoring.find(e=>"exceptionScope"==e.Name).Score),e.mainScope&&(t+=aScoring.find(e=>"mainScope"==e.Name).Score),e.varNaming&&(t+=aScoring.find(e=>"varNaming"==e.Name).Score),e.varNameUse&&(t+=aScoring.find(e=>"varUsed"==e.Name).Score),e.varNameConsts&&(t+=aScoring.find(e=>"varConstant"==e.Name).Score);let n=aScoring.find(e=>"composes"==e.Name).Score-e.composes*aScoring.find(e=>"composesDeduction"==e.Name).Score;n<0&&(n=0),t+=n;let o=aScoring.find(e=>"variables"==e.Name).Score-e.variables*aScoring.find(e=>"variablesDeduction"==e.Name).Score;o<0&&(o=0),t+=o;let r;(r=e.connectionRefs>aScoring.find(e=>"connectionsMin"==e.Name).Score?aScoring.find(e=>"connections"==e.Name).Score-(e.connectionRefs-aScoring.find(e=>"connectionsMin"==e.Name).Score)*aScoring.find(e=>"connectionsDeduction"==e.Name).Score:aScoring.find(e=>"connections"==e.Name).Score)<0&&(r=0),t+=r;let a=aScoring.find(e=>"complexityGreen"==e.Name).Score;e.complexity>oRatings.complexityRe?a=aScoring.find(e=>"complexityRed"==e.Name).Score:e.complexity>oRatings.complexityAm&&(a=aScoring.find(e=>"complexityAmber"==e.Name).Score),t+=a;let l=aScoring.find(e=>"actionsGreen"==e.Name).Score;return e.steps>oRatings.actionRe?l=aScoring.find(e=>"actionsAmber"==e.Name).Score:e.steps>oRatings.actionsAm&&(l=aScoring.find(e=>"actionsAmber"==e.Name).Score),t+=l}function getToday(){let e=new Date;return[e.getFullYear(),e.getMonth()+1,e.getDate()].join("/")}fileInput.onchange=selectFile,fileInputButton.onclick=()=>fileInput.dispatchEvent(new MouseEvent("click"));let result;function apiLink(e,t,n){return"OpenApiConnection"==e?"<a href='#"+n+"-API'>"+t+"</a>":t}function inputFormat(e){if(void 0==e||null==e)return"";let t=e.replaceAll("<","&lt;").replaceAll("\xa3$","");return(t=(t=(t=t.replace(/\\n/g,"\n")).replace(/\\r/g,"")).replace(/\\t/g,"")).replaceAll("{","{ \n").replaceAll("}","} \n")}function listSolution(e){let t=sSolutionTemplate,n="",o="",r="";if(t=(t=(t=(t=t.replace("{flowName}",oDependencies.ImportExportXml.SolutionManifest.UniqueName)).replace("{flowId}",oDependencies.ImportExportXml.SolutionManifest.Version)).replace("{owner}",oDependencies.ImportExportXml.SolutionManifest.Publisher.UniqueName)).replace("{date}",getToday()),e.ConnectionRefs.length>0&&(console.log(e.ConnectionRefs),r='<table class="mui-table mui-table--bordered"><thead><tr><th>Name</th><th>Type</th><th>id</th><th>Cusomizable</th></tr></thead><tbody>',e.ConnectionRefs.forEach(e=>{let t=1==e.iscustomizable;r=r+"<tr><td>"+e.connectionreferencedisplayname+"</td><td>"+e.connectorid.split("/apis/")[1]+"</td><td>"+e.connectionreferencelogicalname+"</td><td>"+t+"</td></tr>"}),r+="</tbody></table>"),oDependencies?.ImportExportXml?.SolutionManifest?.MissingDependencies?.MissingDependency!=void 0){let a=oDependencies.ImportExportXml.SolutionManifest.MissingDependencies.MissingDependency;a&&(n='<table class="mui-table mui-table--bordered"><thead><tr><th>Name</th><th>Type</th><th>Dependent</th></tr></thead><tbody>',a.forEach(e=>{n=n+"<tr><td>"+e.Required.displayName+"</td><td>"+e.Required.type+"</td><td>"+e.Dependent.displayName+"</td></tr>"}),n+="</tbody></table>")}return aEnvironmentVar.length>0&&(o='<table class="mui-table mui-table--bordered"><thead><tr><th>Name</th><th>Type</th><th>Cusomizable</th></tr></thead><tbody>',aEnvironmentVar.forEach(e=>{let t=1==e.environmentvariabledefinition.iscustomizable;o=o+"<tr><td>"+e.environmentvariabledefinition.displayname.default+"</td><td>"+e.environmentvariabledefinition.type+"</td><td>"+t+"</td></tr>"}),o+="</tbody></table>"),t=(t=(t=(t=t.replace("{connectionsTable}",r)).replace("{variablesTable}",o)).replace("{dependenciesTable}",n)).replace("{json}",JSON.stringify(e,void 0,2))}async function fetchAPIData(e,t){try{let n=await fetch(e,{headers:{Authorization:t}});if(!n.ok)throw Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(o){console.error("Error fetching API data:",o)}}let owner="",aActionReturn=[],sActiveTab,sFlowAPI="",sAPIflow="";const regExFlow=RegExp("/flows/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvir=RegExp("/environments/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvirD=RegExp("/environments/Default-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}");function CreateReview(e,t,n,o,r,a,l,s){let c;console.log(a);let d=RegExp("@parameters(.*?)\\)","gm"),p=RegExp("@{parameters(.*?)\\)","gm");aActionReturn.length=0;let g=[],m=[],u=[],f=[],y=[],h="unknown",v="none",b="none",w="none",R="none",x="none",$="none";(""==l||void 0==l)&&(l="please input"),(c=JSON.parse(e)).properties?.displayName!=void 0?(t=c.properties.displayName,n=c.name):void 0!=c.name&&(n=c.name);let I=getChildren(c.properties.definition,[],0,"root");Object.keys(c.properties.definition.triggers).forEach(e=>{value=c.properties.definition.triggers[e],h=e,value?.inputs?.schema!=null&&(v=JSON.stringify(value.inputs)),value?.inputs?.parameters!=null&&(v=JSON.stringify(value.inputs)),value?.inputs?.parameters!=null&&(b=JSON.stringify(value.inputs.parameters)),value?.recurrance!=null&&($=e.recurrance),value?.conditions!=null&&value.conditions[0]?.expression!=null&&(R=value.conditions[0].expression),value?.inputs?.schema?.properties!=null&&(x=JSON.stringify(value.inputs.schema.properties)),value?.runtimeConfiguration!=null&&(w=JSON.stringify(value.runtimeConfiguration))}),I.forEach((e,t)=>{let n="MISSING";e.metadata?.operationMetadataId!=null&&(n=e.metadata.operationMetadataId);let r="",l="",s="";"OpenApiConnection"==e.type?(r=e.inputs.host.operationId,l=e.inputs.host.connectionName,s=e.inputs.host.apiId):(OpenApiConnection=e.type,r=e.type);let c="Standard",g=null;if(""!=l){let m=a.find(e=>e.name.includes(l.substring(0,l.length-2).trim()));"shared_sendmail"==l||"shared_teams"==l?c="Standard":void 0!=m?(c=m.properties.tier,g=m.properties.iconUri):c="Premium"}let u="",f="|",h="Non-Exception";void 0==e.runAfter&&(e.runAfter=e.parent);Object.keys(e.runAfter).forEach(t=>{f+=t+"|",u=t+":"+JSON.stringify(e.runAfter[t]).replaceAll(","," | "),JSON.stringify(e.runAfter[t]).includes("Failed")&&(h="Exception")}),"|"==f&&0==e.nestedLevel&&(f="|trigger|"),"|"==f&&0!=e.nestedLevel&&(f="|"+e.parent+"|"),u.length>1&&(u=u.substring(0,u.length-1));let v,b=o.find(t=>t.Name.includes(r+l)||t.Name==e.type);v=null!=b?Number(b.Complexity):1;let w="";e?.inputs?.parameters?.$filter!=null&&(w=e.inputs.parameters.$filter);let R="",x="";e?.inputs?.retryPolicy!=null&&(R=e.inputs.retryPolicy.type,x=JSON.stringify(e.inputs.retryPolicy));let $="";e?.runtimeConfiguration?.paginationPolicy!=null&&($=e.runtimeConfiguration.paginationPolicy.minimumItemCount);let I="";e?.runtimeConfiguration?.secureData!=null&&(I=JSON.stringify(e.runtimeConfiguration.secureData));let C="";e?.limit?.timeout!=null&&(C=e.limit.timeout);let L="";e?.description!=null&&(L=e.description);let S=e;S.hasOwnProperty("actions")&&delete S.actions;let E=JSON.stringify(S).match(d),A=!1;E&&(E=E.filter(e=>"@parameters('$authentication')"!=e)).length>0&&(A=!0),!A&&(E=JSON.stringify(S).match(p))&&(E=E.filter(e=>"@{parameters('$authentication')"!=e)).length>0&&(A=!0);let k="";e.nestedLevel>0&&(k="Internal");let T="";T=void 0==e.inputs?"":e.inputs.hasOwnProperty("parameters")?JSON.stringify(e.inputs.parameters):JSON.stringify(e.inputs),e.hasOwnProperty("foreach")&&(T=JSON.stringify(e.foreach)),e.hasOwnProperty("expression")&&(T=JSON.stringify(e.expression));let N={name:e.operationName,step:r,type:e.type,id:n,hashId:n+"###"+(t+1),tier:c,connector:l,imgURL:g,runAfter:u.replace(/[\[\]""]/g,""),exception:h,index:t+1,object:e,complexity:v,detail:T,filter:w,pagination:$,secure:I,retry:R,timeout:C,position:f,positionInfo:k,environmentVariables:JSON.stringify(E),environmentB:A,notes:L,parent:e.parent,apiId:s,branch:e.branch};aActionReturn.push(N),N={step:r,connector:l,name:e.operationName,id:n,hashId:n+"###"+(t+1),object:JSON.stringify(e),type:e.type,index:t+1,parent:e.parent},y.push(N)}),aActionReturn.forEach(e=>{if("|trigger|"==e.position)e.positionIndex="|0",e.positionType="|trigger",e.nested="";else{e.positionIndex="",e.positionType="",e.nested="";aActionReturn.filter(t=>e.position.includes("|"+t.name+"|")).forEach(t=>{e.positionIndex+="|"+Number(t.index),e.positionType+="|"+t.type;let n=getNesting(e.parent)+"";"|0"==n.substring(n.length-2,2)&&(n=n.substring(0,n.length-2)),("0"==n||void 0==n||null==n||"undefined"==n)&&(n=""),e.nested=n})}});let C=aActionReturn.filter(e=>null!=e.detail&&void 0!=e.detail&&"InitializeVariable"!=e.type);I.filter(e=>"InitializeVariable"==e.type).forEach(e=>{let t="",n=!1,o=!1,a=e.inputs.variables[0],l=C.filter(e=>"string"==typeof e.detail&&e.detail.includes(a.name));r.data.filter(e=>e.Type==a.type).length>0&&(t=r.data.find(e=>e.Type==a.type).Letter),a.name.substring(0,r.char)==t&&(n=!0),""!=a.value&&void 0!=a.value&&null!=a.value?a.name.substring(1,a.name.length-1)===a.name.substring(1,a.name.length-1).toUpperCase()&&(o=!0):o=!0;let s="";s=isObject(a.value)?JSON.stringify(a.value):void 0==a.value?"":a.value+"",void 0==a.value&&(a.value=""),g.push({name:a.name,type:a.type,value:s,used:l.length>0,named:n,local:o})}),getDistinct(aActionReturn).forEach(e=>{let t=aActionReturn.find(t=>t.connector==e);m.push({conName:e,appId:t.apiId,opId:t.step,count:aActionReturn.filter(t=>t.connector==e).length})}),f=aActionReturn.filter(e=>"OpenApiConnection"==e.type),u=aActionReturn.filter(e=>"Exception"==e.exception);let L;L=0==g.length||g.every(e=>!0===e.named);let S;S=0==g.length||g.every(e=>!0===e.local);let E;E=0==g.length||g.every(e=>!0===e.used);let A=u.filter(e=>"Exception"==e.name),k=!1,T=!1;return A&&(k=A.length>0&&JSON.stringify(A[0].object).includes("Terminate"),T=A.length>0&&(JSON.stringify(A[0].object).includes("concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']")||JSON.stringify(A[0].object).includes("concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']"))),aActionReturn.forEach(e=>{delete e.object,delete e.apiId;let t=aActionReturn.find(t=>t.name==e.parent);null!=t&&"If"!=t.type&&"Switch"!=t.type&&(e.branch="")}),{name:t,id:n,environment:s,owner:l,trigger:h,triggerData:b,triggerParam:v,triggerConfig:w,triggerExpress:R,triggerInputs:x,triggerRecur:$,premium:!aActionReturn.every(e=>"Standard"===e.tier),connectionRefs:m.length,connectors:f.length,steps:aActionReturn.length,variables:g.length,complexity:sumObj(aActionReturn,"complexity"),varNaming:L,varNameConsts:S,varNameUse:E,composes:aActionReturn.filter(e=>"Compose"==e.type).length,exception:u.length,exceptionHandleScope:u.filter(e=>"Scope"==e.step).length>0,exceptionScope:A.length>0,exceptionTerminate:k,exceptionLink:T,mainScope:aActionReturn.filter(e=>"Main"==e.name).length>0,variableArray:g,actionArray:aActionReturn,apiActionArray:f,exceptionArray:u,connectionArray:m,error:"",actionObjectArray:y}}function getNesting(e){let t;if("root"!=e){let n=aActionReturn.find(t=>t.name==e);t=n.index,"root"!=n.parent&&(t+="|"+getNesting(n.parent))}return t}function getChildren(e,t,n,o){if(e?.actions!=void 0&&Object.keys(e.actions).forEach(r=>{let a=e.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=o,a.branch="Yes",t.push(a),t=getChildren(a,t,n+1,r)}),e?.else!=void 0&&Object.keys(e.else.actions).forEach(r=>{let a=e.else.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=o,a.branch="No",t.push(a),t=getChildren(a,t,n+1,r)}),e?.cases!=void 0){Object.keys(e.cases).forEach(r=>{Object.keys(e.cases[r].actions).forEach(a=>{let l=e.cases[r].actions[a];l.operationName=a,l.nestedLevel=n,l.parent=o,l.branch=r,t.push(l),t=getChildren(l,t,n+1,a)})});Object.keys(e.default.actions).forEach(r=>{let a=e.default.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=o,a.branch="Default",t.push(a),t=getChildren(a,t,n+1,a)})}return t}function sumObj(e=[],t){return e.reduce((e,n)=>e+n[t],0)}function getParent(e){return e.sort((e,t)=>e.value-t.value)[0]}function distanceBetween(e,t,n){return Math.abs(e.indexOf(t)-e.indexOf(n))}function getDistinct(e){let t=new Set;for(let n of e)""!=n.connector&&t.add(n.connector);return Array.from(t)}function isObject(e){return e&&"object"==typeof e&&e.constructor===Object}function removeItemById(e,t){return e.filter(e=>e.flow!==t)}"launchQueue"in window&&launchQueue.setConsumer(async e=>{for(let t of e.files){let n=await t.getFile();console.log(n),unpackNestedZipFiles(n)}});